<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CafÃ© Delights - Mobile Login</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
  <style>
    :root {
      --primary-green: #003F2E;
      --accent-gold: #D69C4E;
      --bg-cream: #F9F9F9;
      --text-dark: #212121;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background-color: var(--bg-cream);
      color: var(--text-dark);
      -webkit-tap-highlight-color: transparent;
    }

    .mobile-container {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      background: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .input-field {
      width: 100%;
      padding: 16px;
      border: 2px solid #E5E7EB;
      border-radius: 16px;
      font-size: 16px;
      /* Prevents zoom on iOS */
      transition: all 0.3s ease;
      background: white;
      /* Changed from #F9FAFB to white for contrast */
      color: #333333;
      /* Explicitly visible text color */
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary-green);
      background: white;
    }

    .btn-primary {
      background: var(--primary-green);
      color: white;
      border-radius: 16px;
      padding: 16px;
      font-weight: 700;
      width: 100%;
      transition: transform 0.1s;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .otp-input {
      width: 50px;
      height: 60px;
      border-radius: 12px;
      border: 2px solid #E5E7EB;
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      background: #F9FAFB;
    }

    .otp-input:focus {
      border-color: var(--primary-green);
      background: white;
      outline: none;
    }

    /* Flip Animation */
    .card-flip {
      perspective: 1000px;
      position: relative;
      min-height: 100vh;
    }

    .card-inner {
      transition: transform 0.6s;
      transform-style: preserve-3d;
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 600px;
    }

    .flip-active .card-inner {
      transform: rotateY(180deg);
    }

    .card-face,
    .card-back {
      backface-visibility: hidden;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      padding: 32px 24px;
      -webkit-backface-visibility: hidden;
      /* Safari support */
    }

    .card-back {
      transform: rotateY(180deg);
      z-index: 2;
    }

    /* Hide back face when not flipped */
    .card-flip:not(.flip-active) .card-back {
      visibility: hidden;
    }

    /* Hide front face when flipped */
    .flip-active .card-face:first-child {
      visibility: hidden;
    }
  </style>
</head>

<body>
  <div class="mobile-container" x-data="authApp()">
    <div class="card-flip" :class="{'flip-active': step === 'otp'}">
      <div class="card-inner">

        <!-- LOGIN / SIGNUP SCREEN -->
        <div class="card-face flex flex-col justify-center">
          <div class="mb-8 text-center">
            <div
              class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-primary-green">
              <i class="fas fa-coffee"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2"
              x-text="authMode === 'login' ? 'Welcome Back!' : 'Create Account'">Welcome!</h1>
            <p class="text-gray-500"
              x-text="authMode === 'login' ? 'Enter your mobile to continue' : 'Enter your details to register'">Enter
              your details to continue</p>
          </div>

          <div x-show="error" x-transition class="mb-4 p-4 bg-red-50 text-red-600 rounded-xl text-sm flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span x-text="error"></span>
          </div>

          <form @submit.prevent="submitPhone">
            <!-- Name Input -->
            <!-- Name Input (Signup only) -->
            <div class="mb-4" x-show="authMode === 'signup'" x-transition>
              <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Full Name</label>
              <input type="text" x-model="form.name" class="input-field" placeholder="John Doe">
            </div>

            <!-- Phone Input -->
            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Mobile Number</label>
              <div class="flex space-x-3">
                <select x-model="form.countryCode" class="input-field bg-white flex-none"
                  style="width: 110px; padding-right: 8px;">
                  <option value="+971">ðŸ‡¦ðŸ‡ª +971</option>
                  <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
                  <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                  <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                  <option value="+966">ðŸ‡¸ðŸ‡¦ +966</option>
                </select>
                <input type="tel" x-model="form.phone" class="input-field flex-1" style="min-width: 0;"
                  placeholder="50 123 4567" inputmode="numeric">
              </div>
            </div>

            <button type="submit" class="btn-primary flex items-center justify-center" :disabled="loading">
              <span x-show="!loading">
                <span x-text="authMode === 'login' ? 'Login' : 'Sign Up'"></span>
                <i class="fas fa-arrow-right ml-2"></i>
              </span>
              <span x-show="loading"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
          </form>

          <!-- Toggle Link -->
          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
              <span x-text="authMode === 'login' ? 'Don\'t have an account?' : 'Already have an account?'"></span>
              <button @click="authMode = (authMode === 'login' ? 'signup' : 'login'); error = ''"
                class="text-primary-green font-bold hover:underline ml-1"
                x-text="authMode === 'login' ? 'Sign Up' : 'Log In'">
              </button>
            </p>
          </div>

          <p class="mt-8 text-center text-xs text-gray-400">
            By continuing, you agree to our Terms & Privacy Policy.
          </p>
        </div>

        <!-- OTP VERIFICATION SCREEN -->
        <div class="card-back flex flex-col justify-center">
          <div class="absolute top-8 left-6">
            <button @click="backToLogin" class="text-gray-400 hover:text-gray-900 flex items-center transition-colors">
              <i class="fas fa-arrow-left text-xl mr-2"></i>
              <span class="text-sm font-medium">Back</span>
            </button>
          </div>

          <div class="text-center mb-8">
            <div
              class="w-16 h-16 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-yellow-600">
              <i class="fas fa-lock"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Verify Phone</h2>
            <p class="text-gray-500 text-sm">
              Code sent to <span class="font-bold text-gray-900" x-text="`${form.countryCode} ${form.phone}`"></span>
            </p>
          </div>

          <div x-show="otpError" x-transition
            class="mb-6 p-3 bg-red-50 text-red-600 rounded-xl text-sm flex items-center justify-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span x-text="otpErrorMessage"></span>
          </div>

          <div class="flex justify-center space-x-2 mb-8">
            <template x-for="(digit, index) in 6" :key="index">
              <input type="text" maxlength="1" class="otp-input" :id="'otp-'+index" x-model="otp[index]"
                @input="handleOtpInput($event, index)" @keydown.backspace="handleBackspace($event, index)"
                inputmode="numeric">
            </template>
          </div>

          <button @click="verifyOtp" class="btn-primary mb-6 flex items-center justify-center" :disabled="loading">
            <span x-show="!loading">Verify & Login</span>
            <span x-show="loading"><i class="fas fa-spinner fa-spin"></i></span>
          </button>

          <div class="text-center">
            <p class="text-sm text-gray-500 mb-2">Didn't receive code?</p>
            <button @click="resendOtp" class="text-primary-green font-bold text-sm hover:underline"
              :disabled="timer > 0">
              <span x-show="timer > 0">Resend in <span x-text="timer"></span>s</span>
              <span x-show="timer === 0">Resend SMS</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    function authApp() {
      return {
        authMode: 'login', // login | signup
        step: 'login', // login | otp
        loading: false,
        error: '',
        otpError: false,
        otpErrorMessage: '',
        timer: 60,
        interval: null,

        form: {
          name: '',
          countryCode: '+971',
          phone: ''
        },
        otp: ['', '', '', '', '', ''],

        async submitPhone() {
          if (this.authMode === 'signup' && !this.form.name) return this.error = "Please enter your name";
          if (!this.form.phone) return this.error = "Please enter your mobile number";

          // Phone validation: digits only, reasonable length
          const phoneClean = this.form.phone.replace(/\s+/g, '');
          if (!/^\d+$/.test(phoneClean)) {
            return this.error = "Please enter a valid phone number (digits only)";
          }
          if (phoneClean.length < 7 || phoneClean.length > 15) {
            return this.error = "Please enter a valid phone number (7-15 digits)";
          }

          this.loading = true;
          this.error = '';

          try {
            const res = await fetch('/api/auth/signup', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                ...this.form,
                authMode: this.authMode
              })
            });
            const data = await res.json();

            if (res.ok) {
              this.step = 'otp';
              this.startTimer();
              setTimeout(() => document.getElementById('otp-0').focus(), 500);
            } else {
              if (data.code === 'USER_NOT_FOUND' && this.authMode === 'login') {
                this.error = "Account not found. Please click 'Sign Up' below.";
              } else {
                this.error = data.error || data.message || "Something went wrong";
              }
            }
          } catch (e) {
            this.error = "Network connection failed";
          } finally {
            this.loading = false;
          }
        },

        async verifyOtp() {
          const code = this.otp.join('');
          if (code.length < 6) return;

          this.loading = true;
          this.otpError = false;

          try {
            const res = await fetch('/api/auth/verify-otp', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                countryCode: this.form.countryCode,
                phone: this.form.phone,
                otp: code
              })
            });
            const data = await res.json();

            if (res.ok) {
              window.location.href = '/'; // Dashboard or Home
            } else {
              this.otpError = true;
              this.otpErrorMessage = data.error || "Invalid Code";
              this.otp = ['', '', '', '', '', ''];
              document.getElementById('otp-0').focus();
            }
          } catch (e) {
            this.otpError = true;
            this.otpErrorMessage = "Network error";
          } finally {
            this.loading = false;
          }
        },

        handleOtpInput(e, index) {
          const val = e.target.value;
          if (!/^\d*$/.test(val)) {
            this.otp[index] = '';
            return;
          }
          if (val && index < 5) {
            document.getElementById('otp-' + (index + 1)).focus();
          }
        },

        handleBackspace(e, index) {
          if (!this.otp[index] && index > 0) {
            document.getElementById('otp-' + (index - 1)).focus();
          }
        },

        backToLogin() {
          this.step = 'login';
          this.otp = ['', '', '', '', '', ''];
          this.error = '';
          clearInterval(this.interval);
        },

        startTimer() {
          this.timer = 60;
          if (this.interval) clearInterval(this.interval);
          this.interval = setInterval(() => {
            if (this.timer > 0) this.timer--;
            else clearInterval(this.interval);
          }, 1000);
        },

        async resendOtp() {
          if (this.timer > 0) return;
          this.startTimer();
          // Call backend resend endpoint (reuse signup logic usually works if it handles 'exists')
          try {
            await fetch('/api/auth/signup', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.form)
            });
          } catch (e) { }
        }
      }
    }
  </script>
</body>

</html>