<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout with Location Picker</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        #checkout-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        #checkout-form {
            flex: 1;
            min-width: 300px;
        }

        #map-container {
            flex: 1;
            min-width: 300px;
        }

        #map {
            height: 400px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #45a049;
        }

        .coordinates-display {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div id="checkout-container">
        <div id="checkout-form">
            <h2>Checkout Information</h2>
            <form id="order-form">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>

                <div class="form-group">
                    <label for="address">Delivery Address</label>
                    <input type="text" id="address" name="address" required>
                </div>

                <div class="form-group">
                    <label>Delivery Location</label>
                    <div id="map-container">
                        <div id="map"></div>
                        <p class="coordinates-display">
                            Selected Location: <span id="coordinates">Not selected</span>
                        </p>
                        <button type="button" id="use-current-location">Use My Current Location</button>
                    </div>
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                </div>

                <div class="form-group">
                    <button type="submit">Complete Order</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- <script src="checkout-map.js"></script> -->

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize the map
            const map = L.map('map').setView([0, 0], 2);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Create a marker variable (we'll update this)
            let marker = null;

            // Coordinates display element
            const coordinatesDisplay = document.getElementById('coordinates');
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const addressInput = document.getElementById('address');
            const useCurrentLocationBtn = document.getElementById('use-current-location');

            // Function to update the marker position
            function updateMarker(lat, lng) {
                if (marker) {
                    marker.setLatLng([lat, lng]);
                } else {
                    marker = L.marker([lat, lng], {
                        draggable: true
                    }).addTo(map);

                    // Update position when marker is dragged
                    marker.on('dragend', function (e) {
                        const position = marker.getLatLng();
                        updateCoordinates(position.lat, position.lng);
                        reverseGeocode(position.lat, position.lng);
                    });
                }

                // Center the map on the new position
                map.setView([lat, lng], 15);

                // Update the coordinates display
                updateCoordinates(lat, lng);
            }

            // Function to update the coordinates display
            function updateCoordinates(lat, lng) {
                coordinatesDisplay.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                latitudeInput.value = lat;
                longitudeInput.value = lng;
            }

            // Function to reverse geocode coordinates to address
            async function reverseGeocode(lat, lng) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                    const data = await response.json();

                    if (data.address) {
                        const addressParts = [];
                        if (data.address.road) addressParts.push(data.address.road);
                        if (data.address.house_number) addressParts.push(data.address.house_number);
                        if (data.address.city) addressParts.push(data.address.city);
                        if (data.address.country) addressParts.push(data.address.country);

                        addressInput.value = addressParts.join(', ');
                    }
                } catch (error) {
                    console.error('Reverse geocoding error:', error);
                }
            }

            // Handle map click to add/update marker
            map.on('click', function (e) {
                updateMarker(e.latlng.lat, e.latlng.lng);
                reverseGeocode(e.latlng.lat, e.latlng.lng);
            });

            // Handle "Use Current Location" button click
            useCurrentLocationBtn.addEventListener('click', function () {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function (position) {
                            updateMarker(position.coords.latitude, position.coords.longitude);
                            reverseGeocode(position.coords.latitude, position.coords.longitude);
                        },
                        function (error) {
                            alert('Unable to get your location: ' + error.message);
                        }
                    );
                } else {
                    alert('Geolocation is not supported by your browser.');
                }
            });

            // Handle form submission
            document.getElementById('order-form').addEventListener('submit', function (e) {
                e.preventDefault();

                if (!latitudeInput.value || !longitudeInput.value) {
                    alert('Please select a delivery location on the map.');
                    return;
                }

                // Here you would typically send the form data to your server
                const formData = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: addressInput.value,
                    latitude: latitudeInput.value,
                    longitude: longitudeInput.value
                };

                console.log('Form submitted:', formData);
                alert('Order submitted successfully!');
                // You would typically redirect or show a success message here
            });

            // Optional: Try to get approximate location based on IP at startup
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    if (data.latitude && data.longitude) {
                        updateMarker(data.latitude, data.longitude);
                        reverseGeocode(data.latitude, data.longitude);
                    }
                })
                .catch(error => {
                    console.log('IP-based location not available:', error);
                });
        });
    </script>
</body>

</html>