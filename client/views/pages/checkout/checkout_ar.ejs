<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯ÙØ¹ - Ù…ØªØ¬Ø± Ø§Ù„Ù‚Ù‡ÙˆØ© ÙˆØ§Ù„Ø­Ù„ÙˆÙŠØ§Øª</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://api.fontshare.com/v2/css?f[]=chillax@400,500,600,700&display=swap');

        :root {
            --primary-green: #003F2E;
            --accent-beige: #E6D4B8;
            --text-black: #212121;
            --muted-bg: #F9F9F9;
            --accent-gold: #D69C4E;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--muted-bg);
            color: var(--text-black);
        }

        .font-chillax {
            font-family: 'Cairo', sans-serif;
            /* Fallback to Cairo for Arabic */
        }

        .font-dm-sans {
            font-family: 'Cairo', sans-serif;
            /* Fallback to Cairo for Arabic */
        }

        .bg-primary-green {
            background-color: var(--primary-green);
        }

        .bg-accent-beige {
            background-color: var(--accent-beige);
        }

        .bg-accent-gold {
            background-color: var(--accent-gold);
        }

        .text-primary-green {
            color: var(--primary-green);
        }

        .text-accent-gold {
            color: var(--accent-gold);
        }

        .border-primary-green {
            border-color: var(--primary-green);
        }

        .border-accent-beige {
            border-color: var(--accent-beige);
        }

        .btn-primary {
            background-color: var(--primary-green);
            color: white;
            border-radius: 15px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #002f23;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--accent-gold);
            color: white;
            border-radius: 15px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: #c4823d;
            transform: translateY(-1px);
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .input-field {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(0, 63, 46, 0.1);
        }

        .payment-option {
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .payment-option.selected {
            border-color: var(--primary-green);
            background-color: rgba(0, 63, 46, 0.05);
        }

        .payment-option:hover {
            border-color: var(--accent-gold);
        }

        .order-item {
            border-bottom: 1px solid #f3f4f6;
            padding: 16px 0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .fixed-bottom-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 16px 20px 20px;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }

        .mobile-only {
            display: block;
        }

        .desktop-only {
            display: none;
        }

        @media (min-width: 1024px) {
            .mobile-only {
                display: none;
            }

            .desktop-only {
                display: block;
            }

            .fixed-bottom-btn {
                position: relative;
                box-shadow: none;
                background: transparent;
                padding: 0;
            }
        }

        .location-btn {
            background: rgba(0, 63, 46, 0.1);
            border: 2px dashed var(--primary-green);
            border-radius: 12px;
            color: var(--primary-green);
            transition: all 0.3s ease;
        }

        .location-btn:hover {
            background: rgba(0, 63, 46, 0.15);
        }

        .badge {
            background-color: var(--accent-gold);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
    <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="flex items-center justify-between px-4 py-4 lg:px-6">
            <button class="text-2xl text-primary-green" onclick="window.history.back()">
                <i class="fas fa-arrow-right"></i>
            </button>
            <h1 class="font-chillax text-xl font-bold text-primary-green">Ø§Ù„Ø¯ÙØ¹</h1>
            <div class="w-8"></div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-6 lg:px-6 pb-32 lg:pb-6">
        <div class="lg:grid lg:grid-cols-2 lg:gap-8">
            <!-- Left Column - User Details & Payment -->
            <div class="space-y-6">
                <!-- User Details Section -->
                <section class="card p-6">
                    <h2 class="font-chillax text-xl font-bold mb-6 text-primary-green">
                        <i class="fas fa-user ml-2"></i>
                        ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„
                    </h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block font-dm-sans font-medium text-sm text-gray-700 mb-2">Ø§Ù„Ø§Ø³Ù…
                                Ø§Ù„ÙƒØ§Ù…Ù„</label>
                            <input type="text" name="fullName" class="input-field w-full"
                                placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
                        </div>

                        <div>
                            <label class="block font-dm-sans font-medium text-sm text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø§ØªØµØ§Ù„</label>
                            <input type="tel" name="phone" class="input-field w-full text-right"
                                placeholder="050XXXXXXX" dir="ltr">
                        </div>

                        <!-- Hidden Inputs for Form Submission -->
                        <input type="hidden" name="city" id="hiddenCity">
                        <input type="hidden" name="address" id="hiddenAddress">
                        <input type="hidden" name="latitude" id="hiddenLat">
                        <input type="hidden" name="longitude" id="hiddenLng">

                        <!-- Selected Address Display -->
                        <div id="selected-address-container"
                            class="hidden p-4 bg-green-50 rounded-xl border border-green-100">
                            <label class="block font-dm-sans font-medium text-sm text-primary-green mb-1">Ø§Ù„Ù…ÙˆÙ‚Ø¹
                                Ø§Ù„Ù…Ø­Ø¯Ø¯</label>
                            <p id="display-address" class="text-sm text-gray-700 font-medium"></p>
                            <p id="display-city" class="text-xs text-gray-500 mt-1"></p>
                        </div>

                        <div>
                            <label class="block font-dm-sans font-medium text-sm text-gray-700 mb-2">Ù…ÙˆÙ‚Ø¹
                                Ø§Ù„ØªÙˆØµÙŠÙ„</label>
                            <button type="button" onclick="openMapModal()"
                                class="location-btn w-full p-4 font-dm-sans font-medium flex items-center justify-center gap-2">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„</span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Payment Method Section -->
                <section class="card p-6">
                    <h2 class="font-chillax text-xl font-bold mb-6 text-primary-green">
                        <i class="fas fa-credit-card ml-2"></i>
                        Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
                    </h2>

                    <div class="space-y-4">
                        <% if (paymentSettings && paymentSettings.cod && paymentSettings.cod.isEnabled) { %>
                            <div class="payment-option p-4 selected" onclick="selectPayment(this)">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="text-2xl ml-3">ğŸ’µ</div>
                                        <div>
                                            <h3 class="font-dm-sans font-semibold" payment-name="COD">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
                                            </h3>
                                            <p class="text-sm text-gray-600">Ø§Ø¯ÙØ¹ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø·Ù„Ø¨Ùƒ</p>
                                        </div>
                                    </div>
                                    <div class="radio-btn">
                                        <i class="fas fa-check-circle text-primary-green"></i>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                                <% if (paymentSettings && paymentSettings.stripe && paymentSettings.stripe.isEnabled) {
                                    %>
                                    <div class="payment-option p-4" onclick="selectPayment(this)">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <div class="text-2xl ml-3">ğŸ’³</div>
                                                <div>
                                                    <h3 class="font-dm-sans font-semibold"
                                                        payment-name="Online-payment">Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</h3>
                                                    <p class="text-sm text-gray-600">Ø§Ø¯ÙØ¹ Ø¨Ø£Ù…Ø§Ù† Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p>
                                                </div>
                                            </div>
                                            <div class="radio-btn">
                                                <i class="far fa-circle text-gray-400"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>

                                        <% if ((!paymentSettings?.cod?.isEnabled) &&
                                            (!paymentSettings?.stripe?.isEnabled)) { %>
                                            <div class="p-4 text-center text-red-500 bg-red-50 rounded-lg">
                                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø±Ù‚ Ø¯ÙØ¹ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                                            </div>
                                            <% } %>
                    </div>
                </section>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="mt-6 lg:mt-0">
                <section class="card p-6">
                    <h2 class="font-chillax text-xl font-bold mb-6 text-primary-green">
                        <i class="fas fa-shopping-bag ml-2"></i>
                        Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨
                    </h2>

                    <div class="space-y-4 mb-6">
                        <!-- Order Items -->
                        <% checkoutData.items.forEach((item)=> { %>
                            <div class="order-item">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start space-x-3 space-x-reverse">
                                        <img src="<%= item.image %>" alt="Product Image"
                                            class="w-16 h-16 rounded-lg object-cover">
                                        <div>
                                            <h3 class="font-dm-sans font-semibold">
                                                <%= item.productName %>
                                            </h3>
                                            <p class="text-sm text-gray-600">Ø§Ù„ÙƒÙ…ÙŠØ©: <%= item.qty %>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-left">
                                        <p class="font-dm-sans font-semibold">
                                            <%= item.total %> Ø¯Ø±Ù‡Ù…
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            <%= item.unitPrice %> Ø¯Ø±Ù‡Ù… Ù„Ù„Ù‚Ø·Ø¹Ø©
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <% }); %>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="border-t pt-4 pb-10 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span>
                            <span class="font-dm-sans font-medium">
                                <%= checkoutData?.subTotal %> Ø¯Ø±Ù‡Ù…
                            </span>
                        </div>

                        <% checkoutData.charges.forEach((charge)=> { %>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">
                                    <%= charge.chargingName %>
                                </span>
                                <span class="font-dm-sans font-medium">
                                    <%= charge.price.toFixed(2) %> Ø¯Ø±Ù‡Ù…
                                </span>
                            </div>

                            <% }); %>

                                <!-- Dynamic Delivery Charge -->
                                <div id="delivery-charge-row" class="hidden flex justify-between text-sm">
                                    <span class="text-gray-600 flex items-center">
                                        Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ <span id="distance-badge"
                                            class="mr-2 text-xs bg-gray-100 px-1 rounded text-gray-500"></span>
                                    </span>
                                    <span class="font-dm-sans font-medium">
                                        <span id="delivery-charge-loading" class="hidden text-xs text-gray-400">
                                            <i class="fas fa-spinner fa-spin ml-1"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...
                                        </span>
                                        <span id="delivery-charge-amount-container"><span
                                                id="delivery-charge-amount">0.00</span> Ø¯Ø±Ù‡Ù…</span>
                                    </span>
                                </div>

                                <div class="border-t pt-3">
                                    <div class="flex justify-between">
                                        <span class="font-chillax text-lg font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                                        <span class="font-chillax text-lg font-bold text-primary-green">
                                            <span id="desktop-total-amount">
                                                <%= checkoutData?.totalAmount %>
                                            </span> Ø¯Ø±Ù‡Ù…</span>
                                    </div>
                                </div>
                    </div>

                    <!-- Desktop Place Order Button -->
                    <div class="desktop-only mt-6">
                        <button class="btn-primary w-full py-4 text-lg font-dm-sans font-semibold">
                            <i class="fas fa-check-circle ml-2"></i>
                            Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Mobile Fixed Bottom Button -->
    <div class="mobile-only fixed-bottom-btn">
        <div class="flex items-center justify-between mb-3">
            <div>
                <p class="text-sm text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p>
                <p class="font-chillax text-xl font-bold text-primary-green"><span id="mobile-total-amount">
                        <%= checkoutData?.totalAmount %>
                    </span> Ø¯Ø±Ù‡Ù…
                </p>
            </div>
            <div class="badge">
                <%= checkoutData?.items.length || 'NAN' %>
            </div>
        </div>
        <button id="place-order-btn" class="btn-primary w-full py-4 text-lg font-dm-sans font-semibold">
            <i class="fas fa-check-circle ml-2"></i>
            Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
        </button>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="fixed inset-0 z-50 hidden" style="direction: ltr;">
        <div class="absolute inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeMapModal()"></div>
        <div class="absolute inset-0 md:inset-10 bg-white md:rounded-xl overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="p-4 border-b flex justify-between items-center bg-white z-10" dir="rtl">
                <h3 class="font-chillax text-lg font-bold text-primary-green">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
                <button onclick="closeMapModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Map Container -->
            <div class="flex-grow relative">
                <div id="googleMap" class="w-full h-full"></div>
                <!-- Search Box -->
                <input id="pac-input"
                    class="absolute top-4 left-4 right-14 md:left-auto md:right-4 md:w-80 bg-white p-3 rounded-lg shadow-md border-0 text-sm z-10"
                    type="text" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù…Ø§ÙƒÙ†">
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t bg-white z-10" dir="rtl">
                <div class="mb-3 text-sm text-gray-600">
                    <span class="font-bold">Ø§Ù„Ù…Ø­Ø¯Ø¯:</span> <span id="map-selected-address">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                        Ù„Ù„ØªØ­Ø¯ÙŠØ¯...</span>
                </div>
                <button onclick="confirmLocation()" id="confirm-location-btn" disabled
                    class="btn-primary w-full py-3 font-dm-sans font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                </button>
            </div>
        </div>
    </div>

    <!-- Google Maps Script -->
    <script src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&libraries=places&callback=initMap"
        async defer></script>

    <script>
        // Copying script logic but keeping it mostly standard since logic is language agnostic
        // Only UI strings inside JS might need translation

        let map;
        let marker;
        let geocoder;
        let searchBox;
        let selectedLocationData = null;
        const STORE_ID = "<%= checkoutData.storeId %>";
        const INITIAL_TOTAL = <%= checkoutData.totalAmount || 0 %>;
        let currentDeliveryCharge = 0;
        let allowedEmirates = [];

        async function fetchAllowedEmirates() {
            try {
                const response = await fetch('/checkout/api/allowed-emirates');
                const data = await response.json();
                if (data.success) {
                    allowedEmirates = data.data;
                }
            } catch (error) {
                console.error('Error fetching allowed Emirates:', error);
            }
        }
        fetchAllowedEmirates();

        function initMap() {
            const defaultLoc = { lat: 25.3463, lng: 55.4209 };

            map = new google.maps.Map(document.getElementById("googleMap"), {
                zoom: 13,
                center: defaultLoc,
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false
            });

            geocoder = new google.maps.Geocoder();

            const input = document.getElementById("pac-input");
            searchBox = new google.maps.places.SearchBox(input);

            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });

            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length == 0) return;

                const place = places[0];
                if (!place.geometry || !place.geometry.location) return;

                setMarker(place.geometry.location);
                map.setCenter(place.geometry.location);
                map.setZoom(17);
            });

            map.addListener("click", (e) => {
                setMarker(e.latLng);
            });
        }

        function setMarker(latLng) {
            if (marker) {
                marker.setPosition(latLng);
            } else {
                marker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    animation: google.maps.Animation.DROP
                });
            }

            geocodePosition(latLng);
        }

        function geocodePosition(pos) {
            geocoder.geocode({ location: pos }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                        const address = results[0].formatted_address;
                        const addressComponents = results[0].address_components;
                        let city = "";

                        for (const component of addressComponents) {
                            if (component.types.includes("locality")) {
                                city = component.long_name;
                                break;
                            } else if (component.types.includes("administrative_area_level_1")) {
                                city = component.long_name;
                            }
                        }

                        updateSelectionUI(address, city, pos.lat(), pos.lng());
                    } else {
                        window.alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬");
                    }
                } else {
                    window.alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: " + status);
                }
            });
        }

        function updateSelectionUI(address, city, lat, lng) {
            document.getElementById("map-selected-address").textContent = address;

            const isAllowed = allowedEmirates.some(e => e.toLowerCase() === (city || "").toLowerCase());

            const confirmBtn = document.getElementById("confirm-location-btn");
            if (isAllowed || allowedEmirates.length === 0) {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('bg-red-500');
                confirmBtn.classList.add('btn-primary');
                confirmBtn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
            } else {
                confirmBtn.disabled = true;
                confirmBtn.classList.remove('btn-primary', 'bg-red-500');
                confirmBtn.classList.add('bg-gray-400');
                confirmBtn.innerHTML = `ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ ${city || 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'}`;
            }

            selectedLocationData = {
                address: address,
                city: city || "Dubai",
                lat: lat,
                lng: lng
            };
        }

        function openMapModal() {
            document.getElementById("mapModal").classList.remove("hidden");
            if (map) {
                google.maps.event.trigger(map, "resize");
            }
        }

        function closeMapModal() {
            document.getElementById("mapModal").classList.add("hidden");
        }

        function confirmLocation() {
            if (!selectedLocationData) return;

            document.getElementById("hiddenAddress").value = selectedLocationData.address;
            document.getElementById("hiddenCity").value = selectedLocationData.city;
            document.getElementById("hiddenLat").value = selectedLocationData.lat;
            document.getElementById("hiddenLng").value = selectedLocationData.lng;

            document.getElementById("display-address").textContent = selectedLocationData.address;
            document.getElementById("display-city").textContent = selectedLocationData.city;
            document.getElementById("selected-address-container").classList.remove("hidden");

            const btnSpan = document.querySelector(".location-btn span");
            if (btnSpan) btnSpan.textContent = "ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹";

            closeMapModal();
            fetchDeliveryCharge();
        }

        async function fetchDeliveryCharge() {
            if (!selectedLocationData || !STORE_ID) return;

            const row = document.getElementById('delivery-charge-row');
            const loading = document.getElementById('delivery-charge-loading');
            const amountContainer = document.getElementById('delivery-charge-amount-container');
            const placeOrderBtns = document.querySelectorAll('#place-order-btn, .desktop-only button');

            try {
                if (row) row.classList.remove('hidden');
                if (loading) loading.classList.remove('hidden');
                if (amountContainer) amountContainer.classList.add('hidden');
                placeOrderBtns.forEach(btn => btn.disabled = true);

                const queryParams = new URLSearchParams({
                    latitude: selectedLocationData.lat,
                    longitude: selectedLocationData.lng,
                    emirate: selectedLocationData.city,
                    branchId: STORE_ID
                });

                const response = await fetch(`/checkout/api/delivery-charge?${queryParams.toString()}`);
                const data = await response.json();

                if (data.success) {
                    currentDeliveryCharge = data.data.deliveryCharge;
                    updateDeliveryChargeUI(data.data);
                } else {
                    showErrorMessage(data.message || 'ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„');
                    if (row) row.classList.add('hidden');
                    updateDeliveryChargeUI({ deliveryCharge: 0, distance: 0 });
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©');
                if (row) row.classList.add('hidden');
                updateDeliveryChargeUI({ deliveryCharge: 0, distance: 0 });
            } finally {
                if (loading) loading.classList.add('hidden');
                if (amountContainer) amountContainer.classList.remove('hidden');
                placeOrderBtns.forEach(btn => btn.disabled = false);
            }
        }

        function updateDeliveryChargeUI(data) {
            const row = document.getElementById('delivery-charge-row');
            const amountSpan = document.getElementById('delivery-charge-amount');
            const distanceSpan = document.getElementById('distance-badge');
            const desktopTotalSpan = document.getElementById('desktop-total-amount');
            const mobileTotalSpan = document.getElementById('mobile-total-amount');

            if (row) row.classList.remove('hidden');
            if (amountSpan) amountSpan.textContent = data.deliveryCharge.toFixed(2);
            if (distanceSpan) distanceSpan.textContent = `${data.distance} ÙƒÙ…`;

            const newTotal = (INITIAL_TOTAL + data.deliveryCharge).toFixed(2);
            if (desktopTotalSpan) desktopTotalSpan.textContent = newTotal;
            if (mobileTotalSpan) mobileTotalSpan.textContent = newTotal;
        }
    </script>

    <script>
        function selectPayment(element) {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
                const icon = option.querySelector('.radio-btn i');
                icon.className = 'far fa-circle text-gray-400';
            });

            element.classList.add('selected');
            const icon = element.querySelector('.radio-btn i');
            icon.className = 'fas fa-check-circle text-primary-green';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const inputs = document.querySelectorAll('.input-field');
            inputs.forEach(input => {
                input.addEventListener('focus', function () {
                    this.style.transform = 'translateY(-1px)';
                });

                input.addEventListener('blur', function () {
                    this.style.transform = 'translateY(0)';
                });
            });

            const placeOrderBtn = document.getElementById('place-order-btn');
            if (placeOrderBtn) {
                placeOrderBtn.addEventListener('click', handlePlaceOrder);
            }

            const desktopPlaceOrderBtn = document.querySelector('.desktop-only button');
            if (desktopPlaceOrderBtn) {
                desktopPlaceOrderBtn.addEventListener('click', handlePlaceOrder);
            }
        });

        async function handlePlaceOrder(event) {
            event.preventDefault();

            try {
                showLoadingState();
                const formData = collectFormData();

                if (!validateFormData(formData)) {
                    hideLoadingState();
                    return;
                }

                const response = await sendPlaceOrderRequest(formData);
                handleOrderResponse(response);

            } catch (error) {
                console.error('Place order error:', error);
                hideLoadingState();
                showErrorMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        function collectFormData() {
            const selectedPayment = document.querySelector('.payment-option.selected');
            const paymentMethod = selectedPayment ?
                selectedPayment.querySelector('[payment-name]').getAttribute('payment-name') : 'COD';

            return {
                fullName: document.querySelector('input[name="fullName"]')?.value?.trim() || '',
                phone: document.querySelector('input[name="phone"]')?.value?.trim() || '',
                city: document.querySelector('input[name="city"]')?.value?.trim() || '',
                address: document.querySelector('input[name="address"]')?.value?.trim() || '',
                latitude: document.querySelector('input[name="latitude"]')?.value || '',
                longitude: document.querySelector('input[name="longitude"]')?.value || '',
                paymentMethod: paymentMethod,
                deliveryCharge: currentDeliveryCharge
            };
        }

        function validateFormData(formData) {
            const requiredFields = [
                { field: 'fullName', message: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„' },
                { field: 'phone', message: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø§ØªØµØ§Ù„' },
                { field: 'address', message: 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„' }
            ];

            for (const { field, message } of requiredFields) {
                if (!formData[field]) {
                    showErrorMessage(message);
                    if (field === 'address') {
                        const locBtn = document.querySelector('.location-btn');
                        if (locBtn) {
                            locBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            locBtn.classList.add('border-red-500');
                            setTimeout(() => locBtn.classList.remove('border-red-500'), 3000);
                        }
                    } else {
                        focusField(field);
                    }
                    return false;
                }
            }

            const phoneRegex = /^(\+971|0)?[0-9]{9}$/;
            if (!phoneRegex.test(formData.phone.replace(/\s/g, ''))) {
                showErrorMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø¥Ù…Ø§Ø±Ø§ØªÙŠ ØµØ§Ù„Ø­');
                focusField('phone');
                return false;
            }

            if (!formData.latitude || !formData.longitude) {
                showErrorMessage('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©');
                return false;
            }

            return true;
        }

        function focusField(fieldName) {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field) {
                field.focus();
                field.style.borderColor = '#ef4444';
                setTimeout(() => {
                    field.style.borderColor = '';
                }, 3000);
            }
        }

        async function sendPlaceOrderRequest(formData) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            try {
                const response = await fetch('/checkout/place-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') throw new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨');
                throw error;
            }
        }

        function handleOrderResponse(response) {
            hideLoadingState();

            if (!response || !response.status) {
                showErrorMessage('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
                return;
            }

            switch (response.status) {
                case 'COD':
                    showOrderConfirmation(response.data);
                    break;
                case 'COO':
                    showStripeCheckout(response.data);
                    break;
                default:
                    showErrorMessage('Ø­Ø§Ù„Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©');
            }
        }

        function showLoadingState() {
            const buttons = [
                document.getElementById('place-order-btn'),
                document.querySelector('.desktop-only button')
            ].filter(Boolean);

            buttons.forEach(btn => {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
                btn.style.opacity = '0.8';
            });
        }

        function hideLoadingState() {
            const buttons = [
                document.getElementById('place-order-btn'),
                document.querySelector('.desktop-only button')
            ].filter(Boolean);

            buttons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle ml-2"></i>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨';
                btn.style.opacity = '1';
            });
        }

        function showOrderConfirmation(orderData) {
            const overlay = createFullScreenOverlay();
            let paymentMethodName = orderData?.paymentMethod === 'Cash' ? 'Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : 'Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';

            overlay.innerHTML = `
        <div class="confirmation-container">
            <div class="celebration-animation">
                <div class="confetti">ğŸ‰</div>
                <div class="confetti">ğŸŠ</div>
                <div class="confetti">âœ¨</div>
            </div>
            
            <div class="confirmation-content">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <h2>ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨!</h2>
                <p class="order-id">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: #${orderData.orderId || ''}</p>
                <div class="success-message">
                    <p>ğŸ‰ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</p>
                    <p>ğŸ’° Ø§Ù„Ø¯ÙØ¹: ${paymentMethodName}</p>
                    <p>ğŸšš Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
                </div>
                
                <div class="countdown-container">
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø®Ù„Ø§Ù„ <span id="countdown">5</span> Ø«ÙˆØ§Ù†ÙŠ...</p>
                    <div class="countdown-bar">
                        <div class="countdown-progress"></div>
                    </div>
                </div>
            </div>
        </div>
    `;

            document.body.appendChild(overlay);
            addCelebrationAnimations(overlay);
            startCountdown(5, () => {
                window.location.href = '/';
            });
        }

        function showStripeCheckout(paymentData) {
            const overlay = createFullScreenOverlay();

            overlay.innerHTML = `
        <div class="stripe-container">
            <div class="stripe-header">
                <button class="close-stripe" onclick="closeStripeCheckout()">
                    <i class="fas fa-times"></i>
                </button>
                <h2>Ø¯ÙØ¹ Ø¢Ù…Ù†</h2>
            </div>
            
            <div class="stripe-content">
                <div id="stripe-element"></div>
                <div class="payment-summary">
                    <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong>AED ${paymentData?.amount / 100 || '0.00'}</strong></p>
                </div>
                
                <button id="stripe-pay-btn" class="btn-primary w-full py-4 mt-4">
                    <i class="fas fa-credit-card ml-2"></i>
                    Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†
                </button>
            </div>
            
            <div class="stripe-footer">
                <p><i class="fas fa-lock ml-1"></i> Ù…Ø¤Ù…Ù† Ø¨ÙˆØ§Ø³Ø·Ø© Stripe</p>
            </div>
        </div>
    `;

            document.body.appendChild(overlay);
            initializeStripe(paymentData);
        }

        async function initializeStripe(paymentData) {
            if (typeof Stripe === 'undefined') {
                showErrorMessage('Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹ ØºÙŠØ± Ù…ØªØ§Ø­');
                closeStripeCheckout();
                return;
            }

            const stripe = Stripe('<%= paymentSettings.stripe.publishableKey %>');
            const elements = stripe.elements();
            const cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#32325d',
                        fontFamily: '"Cairo", sans-serif',
                        direction: 'ltr', // Card numbers always LTR
                        '::placeholder': { color: '#aab7c4' }
                    }
                }
            });

            cardElement.mount('#stripe-element');
            const payButton = document.getElementById('stripe-pay-btn');

            payButton.addEventListener('click', async (e) => {
                e.preventDefault();
                payButton.disabled = true;
                const originalText = payButton.innerHTML;
                payButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

                try {
                    const { error, paymentIntent } = await stripe.confirmCardPayment(paymentData.client_secret, {
                        payment_method: {
                            card: cardElement,
                            billing_details: {
                                name: document.querySelector('input[name="fullName"]')?.value || 'Customer'
                            }
                        },
                    });

                    if (error) {
                        showErrorMessage(error.message);
                        payButton.disabled = false;
                        payButton.innerHTML = originalText;
                    } else {
                        if (paymentIntent.status === 'succeeded') {
                            closeStripeCheckout();
                            showOrderConfirmation({
                                ...paymentIntent,
                                paymentMethod: 'Online',
                                orderId: paymentData.metadata?.orderId
                            });
                        } else {
                            showErrorMessage('ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹');
                            payButton.disabled = false;
                            payButton.innerHTML = originalText;
                        }
                    }
                } catch (err) {
                    showErrorMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹');
                    payButton.disabled = false;
                    payButton.innerHTML = originalText;
                }
            });
        }

        function createFullScreenOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'fullscreen-overlay';

            const style = document.createElement('style');
            style.textContent = `
        .fullscreen-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .confirmation-container, .failure-container, .stripe-container {
            background: white; padding: 40px; border-radius: 20px;
            max-width: 500px; width: 90%; text-align: center;
            position: relative;
        }
        .success-icon { font-size: 4rem; color: var(--primary-green); margin-bottom: 20px; }
        .confirmation-content h2 { font-size: 2rem; color: var(--primary-green); margin-bottom: 10px; font-family: 'Cairo', sans-serif;}
        .countdown-bar { width: 100%; height: 4px; background: #e5e7eb; margin-top: 10px; }
        .countdown-progress { height: 100%; background: var(--primary-green); transition: width linear; }
        .stripe-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
        .close-stripe { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
    `;

            if (!document.querySelector('#overlay-styles')) {
                style.id = 'overlay-styles';
                document.head.appendChild(style);
            }
            return overlay;
        }

        function addCelebrationAnimations(overlay) {
            const confettiElements = overlay.querySelectorAll('.confetti');

            confettiElements.forEach((confetti, index) => {
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = (index * 0.5) + 's';
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
            });
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('Audio notification not available');
            }
        }

        function startCountdown(seconds, callback) {
            const countdownElement = document.getElementById('countdown');
            const progressElement = document.querySelector('.countdown-progress');
            if (!countdownElement || !progressElement) return;

            let remaining = seconds;
            progressElement.style.width = '100%';
            progressElement.style.transitionDuration = `${seconds}s`;

            setTimeout(() => { progressElement.style.width = '0%'; }, 100);

            const timer = setInterval(() => {
                remaining--;
                countdownElement.textContent = remaining;
                if (remaining <= 0) {
                    clearInterval(timer);
                    callback();
                }
            }, 1000);
        }

        function showErrorMessage(message) {
            const existingError = document.querySelector('.error-toast');
            if (existingError) existingError.remove();

            const errorToast = document.createElement('div');
            errorToast.className = 'error-toast';
            errorToast.innerHTML = `<div class="error-content"><i class="fas fa-exclamation-circle"></i><span>${message}</span></div>`;

            const errorStyle = document.createElement('style');
            errorStyle.textContent = `
        .error-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 15px 25px;
            border-radius: 10px; z-index: 10000; font-family: 'Cairo', sans-serif;
        }
        .error-content { display: flex; align-items: center; gap: 10px; }
            `;
            if (!document.querySelector('#error-styles')) {
                errorStyle.id = 'error-styles';
                document.head.appendChild(errorStyle);
            }

            document.body.appendChild(errorToast);
            setTimeout(() => errorToast.remove(), 5000);
        }

        function closeStripeCheckout() {
            const overlay = document.querySelector('.fullscreen-overlay');
            if (overlay) overlay.remove();
        }
    </script>

</body>

</html>