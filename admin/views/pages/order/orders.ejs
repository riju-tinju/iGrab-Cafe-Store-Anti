<%- include('../../partials/Header') %>

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGrab Cafe - Orders Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body class="bg-gray-100">
    <style>
      .brand-teal {
        background-color: #1E7065;
      }

      .brand-teal-light {
        background-color: #2F8A7B;
      }

      .brand-orange {
        background-color: #F59E0B;
      }

      .text-brand-teal {
        color: #1E7065;
      }

      .border-brand-teal {
        border-color: #1E7065;
      }

      .hover-brand-teal:hover {
        background-color: #1E7065;
      }

      .order-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
      }

      .order-card:hover {
        border-left-color: #1E7065;
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .order-card.selected {
        border-left-color: #1E7065;
        background-color: #f0f9f7;
      }

      /* Order Status Styles */
      .status-pending {
        background-color: #F59E0B;
        color: white;
      }

      .status-placed {
        background-color: #3B82F6;
        color: white;
      }

      .status-confirmed {
        background-color: #10B981;
        color: white;
      }

      .status-processing {
        background-color: #8B5CF6;
        color: white;
      }

      .status-delivered {
        background-color: #059669;
        color: white;
      }

      .status-cancelled {
        background-color: #EF4444;
        color: white;
      }

      /* Payment Status Styles */
      .payment-paid {
        background-color: #10B981;
        color: white;
      }

      .payment-unpaid {
        background-color: #F59E0B;
        color: white;
      }

      .payment-failed {
        background-color: #EF4444;
        color: white;
      }

      .filter-active {
        background-color: #1E7065;
        color: white;
      }

      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1E7065;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .error-state {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      }

      .empty-state {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Status Select Styles */
      .status-select {
        /* background: transparent; */
        border: 1px solid transparent;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        color: white;
      }

      .status-select:hover {
        opacity: 0.8;
        border-color: rgba(255, 255, 255, 0.3);
      }

      .status-select:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
      }

      .status-select.updating {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Date Range Picker */
      .date-range-picker {
        position: relative;
      }

      .date-range-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 50;
        min-width: 300px;
        display: none;
      }

      .date-range-dropdown.show {
        display: block;
      }

      /* Export Progress */
      .export-progress {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 32px;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 300px;
        display: none;
      }

      .export-progress.show {
        display: block;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background-color: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background-color: #1E7065;
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 0%;
      }

      /* Toast notification styles */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: 400px;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        background-color: #10b981;
      }

      .toast.error {
        background-color: #ef4444;
      }

      .toast.warning {
        background-color: #f59e0b;
      }

      .toast.info {
        background-color: #3b82f6;
      }

      /* Mobile optimizations */
      @media (max-width: 768px) {
        .order-card {
          border-left: none;
          border-top: 4px solid transparent;
        }

        .order-card:hover,
        .order-card.selected {
          border-left: none;
          border-top-color: #1E7065;
        }

        .mobile-scroll {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }

        .status-select {
          font-size: 10px;
          padding: 2px 6px;
        }
      }

      /* Bulk actions bar */
      .bulk-actions-bar {
        position: sticky;
        top: 0;
        background: #1E7065;
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        transform: translateY(-100px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 40;
      }

      .bulk-actions-bar.show {
        transform: translateY(0);
        opacity: 1;
      }

      /* Order items preview */
      .order-items-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-width: 200px;
      }

      .order-item-badge {
        background-color: #f3f4f6;
        color: #374151;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 10px;
        white-space: nowrap;
      }

      /* Address tooltip */
      .address-tooltip {
        position: relative;
        cursor: help;
      }

      .address-tooltip:hover .tooltip-content {
        opacity: 1;
        visibility: visible;
      }

      .tooltip-content {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 50;
        max-width: 300px;
        white-space: normal;
      }

      .tooltip-content::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: #1f2937;
      }
    </style>

    <!-- Main Content -->
    <main class="main-content p-4 sm:p-6">
      <!-- Header Section -->
      <div class="mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
          <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Orders Management</h1>
            <p class="text-gray-600">Manage customer orders, track deliveries, and process payments</p>
          </div>
          <div class="flex space-x-3 mt-4 sm:mt-0">
            <button id="bulkExportBtn" disabled
              class="border border-brand-teal text-brand-teal px-4 py-2 rounded-lg font-semibold transition-all duration-200 hover:bg-teal-50 disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-download mr-2"></i>Export Selected
            </button>
            <!-- <button onclick="window.location.href='/orders/create'"
            class="brand-teal hover:brand-teal-light text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all duration-200 transform hover:scale-105">
            <i class="fas fa-plus mr-2"></i>New Order
          </button> -->
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="statsCards">
          <!-- Stats will be populated by JavaScript -->
        </div>

        <!-- Revenue Chart -->
        <!-- <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          <i class="fas fa-chart-line text-brand-teal mr-2"></i>
          Orders & Revenue Trend (Last 7 Days)
        </h3>
        <div style="height: 300px;">
          <canvas id="revenueChart"></canvas>
        </div>
      </div> -->
      </div>

      <!-- Bulk Actions Bar -->
      <div id="bulkActionsBar" class="bulk-actions-bar">
        <div class="flex flex-wrap items-center justify-between" style="row-gap: 10px;">
          <div class="flex flex-wrap items-center" style="row-gap: 10px;column-gap: 15px;">
            <span id="selectedCount">0 orders selected</span>
            <button id="selectAllBtn" class="text-sm hover:underline">Select All</button>
            <button id="clearSelectionBtn" class="text-sm hover:underline">Clear Selection</button>
          </div>
          <div class="flex flex-wrap items-center" style="row-gap: 10px;column-gap: 15px;">
            <select id="bulkStatusUpdate" class="bg-white text-gray-900 px-3 py-1 rounded text-sm">
              <option value="">Update Status</option>
              <option value="Placed">Mark as Placed</option>
              <option value="Confirmed">Mark as Confirmed</option>
              <option value="Processing">Mark as Processing</option>
              <option value="Delivered">Mark as Delivered</option>
              <option value="Cancelled">Mark as Cancelled</option>
            </select>
            <button id="bulkUpdateBtn"
              class="bg-white text-brand-teal px-4 py-1 rounded text-sm font-medium hover:bg-gray-100">
              Update
            </button>
            <button id="bulkExportSelectedBtn"
              class="bg-white text-brand-teal px-4 py-1 rounded text-sm font-medium hover:bg-gray-100">
              <i class="fas fa-download mr-1"></i>Export
            </button>
          </div>
        </div>
      </div>

      <!-- Search and Filters -->
      <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
        <div class="flex flex-col gap-4">
          <!-- Search and Date Range -->
          <div class="flex flex-col lg:flex-row lg:items-center gap-4">
            <!-- Search -->
            <div class="flex-1 relative">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
              <input type="text" id="searchInput" placeholder="Search by Order ID, Customer name, or Phone..."
                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
              <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                <i class="fas fa-times cursor-pointer text-gray-400 hover:text-gray-600 hidden" id="clearSearch"></i>
              </div>
            </div>

            <!-- Date Range Picker -->
            <div class="date-range-picker">
              <button id="dateRangeBtn"
                class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                <i class="fas fa-calendar mr-2 text-gray-400"></i>
                <span id="dateRangeText">All Time</span>
                <i class="fas fa-chevron-down ml-2 text-gray-400"></i>
              </button>
              <div id="dateRangeDropdown" class="date-range-dropdown">
                <div class="p-4">
                  <div class="space-y-2 mb-4">
                    <button class="date-preset w-full text-left px-3 py-2 hover:bg-gray-50 rounded" data-preset="today">
                      Today
                    </button>
                    <button class="date-preset w-full text-left px-3 py-2 hover:bg-gray-50 rounded"
                      data-preset="yesterday">
                      Yesterday
                    </button>
                    <button class="date-preset w-full text-left px-3 py-2 hover:bg-gray-50 rounded"
                      data-preset="last7days">
                      Last 7 Days
                    </button>
                    <button class="date-preset w-full text-left px-3 py-2 hover:bg-gray-50 rounded"
                      data-preset="last30days">
                      Last 30 Days
                    </button>
                    <button class="date-preset w-full text-left px-3 py-2 hover:bg-gray-50 rounded"
                      data-preset="thismonth">
                      This Month
                    </button>
                  </div>
                  <div class="border-t pt-4">
                    <div class="grid grid-cols-2 gap-2 mb-3">
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">From</label>
                        <input type="date" id="dateFrom" class="w-full px-2 py-1 border rounded text-sm">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">To</label>
                        <input type="date" id="dateTo" class="w-full px-2 py-1 border rounded text-sm">
                      </div>
                    </div>
                    <div class="flex justify-end space-x-2">
                      <button id="clearDateRange" class="px-3 py-1 text-sm text-gray-600 hover:bg-gray-50 rounded">
                        Clear
                      </button>
                      <button id="applyDateRange"
                        class="px-3 py-1 text-sm bg-brand-teal text-white rounded hover:bg-teal-700">
                        Apply
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="flex flex-wrap gap-2" id="filterButtons">
            <!-- Order Status Filters -->
            <div class="flex flex-wrap gap-2">
              <button
                class="filter-btn filter-active px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                data-filter="all" data-type="status">
                <i class="fas fa-list mr-1"></i>All Orders
              </button>
              <button
                class="filter-btn px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                data-filter="Pending" data-type="status">
                <i class="fas fa-clock mr-1"></i>Pending
              </button>
              <button
                class="filter-btn px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                data-filter="Confirmed" data-type="status">
                <i class="fas fa-check-circle mr-1"></i>Confirmed
              </button>
              <button
                class="filter-btn px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                data-filter="Processing" data-type="status">
                <i class="fas fa-cog mr-1"></i>Processing
              </button>
              <button
                class="filter-btn px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                data-filter="Delivered" data-type="status">
                <i class="fas fa-truck mr-1"></i>Delivered
              </button>
            </div>

            <!-- Payment Status Filters -->
            <div class="border-l pl-2 ml-2 flex flex-wrap gap-2">
              <button
                class="filter-btn px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                data-filter="Unpaid" data-type="payment">
                <i class="fas fa-exclamation-triangle mr-1"></i>Unpaid
              </button>
              <button
                class="filter-btn px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                data-filter="Failed" data-type="payment">
                <i class="fas fa-times-circle mr-1"></i>Failed
              </button>
            </div>

            <!-- Payment Method Filters -->
            <div class="border-l pl-2 ml-2 flex flex-wrap gap-2">
              <button
                class="filter-btn px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                data-filter="Cash" data-type="method">
                <i class="fas fa-money-bill mr-1"></i>Cash
              </button>
              <button
                class="filter-btn px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                data-filter="Online" data-type="method">
                <i class="fas fa-credit-card mr-1"></i>Online
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="hidden bg-white rounded-lg shadow-sm border p-8">
        <div class="flex flex-col items-center justify-center">
          <div class="loading-spinner mb-4"></div>
          <p class="text-gray-600">Loading orders...</p>
        </div>
      </div>

      <!-- Error State -->
      <div id="errorState" class="hidden error-state rounded-lg border p-8">
        <div class="flex flex-col items-center justify-center text-center">
          <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
          <h3 class="text-lg font-semibold text-red-800 mb-2">Something went wrong</h3>
          <p class="text-red-600 mb-4" id="errorMessage">Failed to load orders. Please try again.</p>
          <button id="retryBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
            <i class="fas fa-redo mr-2"></i>Retry
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden empty-state rounded-lg border p-8">
        <div class="flex flex-col items-center justify-center text-center">
          <i class="fas fa-shopping-cart text-4xl text-gray-400 mb-4"></i>
          <h3 class="text-lg font-semibold text-gray-700 mb-2">No orders found</h3>
          <p class="text-gray-500 mb-4">Try adjusting your search or filter criteria.</p>
          <button id="clearFiltersBtn"
            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
            <i class="fas fa-filter mr-2"></i>Clear Filters
          </button>
        </div>
      </div>

      <!-- Orders Grid/Table -->
      <div id="ordersContainer" class="bg-white rounded-lg shadow-sm border">
        <!-- Desktop Table View -->
        <div class="hidden lg:block overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="text-left p-4 w-12">
                  <input type="checkbox" id="selectAllOrders"
                    class="rounded border-gray-300 text-brand-teal focus:ring-brand-teal">
                </th>
                <th class="text-left p-4 font-semibold text-gray-900">Order Details</th>
                <th class="text-left p-4 font-semibold text-gray-900">Customer</th>
                <th class="text-left p-4 font-semibold text-gray-900">Items</th>
                <th class="text-left p-4 font-semibold text-gray-900 cursor-pointer hover:bg-gray-100"
                  id="sortByAmount">
                  Amount <i class="fas fa-sort ml-1"></i>
                </th>
                <th class="text-left p-4 font-semibold text-gray-900">Payment</th>
                <th class="text-left p-4 font-semibold text-gray-900">Status</th>
                <th class="text-left p-4 font-semibold text-gray-900 cursor-pointer hover:bg-gray-100" id="sortByDate">
                  Date <i class="fas fa-sort ml-1"></i>
                </th>
                <th class="text-left p-4 font-semibold text-gray-900">
                  <i class="fas fa-motorcycle ml-1"></i>
                </th>
                <!-- <th class="text-left p-4 font-semibold text-gray-900">Actions</th> -->
              </tr>
            </thead>
            <tbody id="ordersTableBody">
              <!-- Orders will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Mobile Card View -->
        <div class="lg:hidden" id="ordersMobileView">
          <!-- Orders will be populated by JavaScript -->
        </div>
      </div>

      <!-- Pagination -->
      <div class="mt-6 flex flex-col sm:flex-row items-center justify-between" id="paginationContainer">
        <div class="text-sm text-gray-700 mb-4 sm:mb-0" id="paginationInfo">
          <!-- Pagination info will be populated -->
        </div>
        <div class="flex items-center space-x-2" id="paginationButtons">
          <!-- Pagination buttons will be populated -->
        </div>
      </div>
    </main>

    <!-- Export Progress Modal -->
    <div id="exportProgress" class="export-progress">
      <div class="text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Exporting Orders</h3>
        <p class="text-gray-600 mb-4" id="exportStatus">Preparing export...</p>
        <div class="progress-bar mb-4">
          <div id="exportProgressFill" class="progress-fill"></div>
        </div>
        <p class="text-sm text-gray-500" id="exportDetails">This may take a few moments</p>
      </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <script>
      // API Configuration and State Management
      const API_BASE_URL = '/api'; // Change this to your actual API base URL
      let currentPage = 1;
      let currentFilters = {
        status: 'all',
        paymentStatus: '',
        paymentMethod: '',
        dateFrom: '',
        dateTo: ''
      };
      let currentSearch = '';
      let currentSort = {
        field: 'orderDate',
        direction: 'desc'
      };
      let searchTimeout = null;
      let selectedOrders = new Set();
      let allOrders = [];

      // Order Status Manager
      class OrderStatusManager {
        static async updateStatus(orderId, newStatus, selectElement) {
          try {
            // Store original value for potential rollback
            const originalStatus = selectElement.dataset.originalValue;

            // Update UI to saving state
            selectElement.classList.add('updating');
            selectElement.disabled = true;

            // Make API call
            const response = await fetch(`${API_BASE_URL}/orders/${orderId}/status`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                status: newStatus
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error?.message || 'Failed to update order status');
            }

            // Update UI to success state
            selectElement.dataset.originalValue = newStatus;
            selectElement.className = `status-select status-${newStatus.toLowerCase()}`;

            // Show success toast
            ToastManager.show(`Order status updated to ${newStatus}`, 'success');

            // Update the status badge in the row
            this.updateStatusBadge(orderId, newStatus);

            return data;

          } catch (error) {
            console.error('Status Update Error:', error);

            // Rollback to original value
            selectElement.value = selectElement.dataset.originalValue;

            // Show error toast
            ToastManager.show(error.message || 'Failed to update order status', 'error');

            throw error;
          } finally {
            // Remove updating state
            selectElement.classList.remove('updating');
            selectElement.disabled = false;
          }
        }

        static updateStatusBadge(orderId, newStatus) {
          const statusBadge = document.querySelector(`[data-order-id="${orderId}"] .status-badge`);
          if (statusBadge) {
            statusBadge.className = `status-badge px-2 py-1 text-xs font-medium rounded-full status-${newStatus.toLowerCase()}`;
            statusBadge.textContent = newStatus;
          }
        }

        static setupStatusSelect(selectElement, orderId) {
          // Store original value
          selectElement.dataset.originalValue = selectElement.value;

          // Change event
          selectElement.addEventListener('change', (e) => {
            const newStatus = e.target.value;
            if (newStatus !== selectElement.dataset.originalValue) {
              this.updateStatus(orderId, newStatus, selectElement);
            }
          });
        }
      }

      // Toast Notification Manager
      class ToastManager {
        static show(message, type = 'success', duration = 3000) {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} mr-2"></i>
              <span>${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;

          document.getElementById('toastContainer').appendChild(toast);

          // Show toast
          setTimeout(() => toast.classList.add('show'), 100);

          // Auto-hide toast
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
              if (toast.parentElement) {
                toast.remove();
              }
            }, 300);
          }, duration);
        }
      }

      // Export Manager
      class ExportManager {
        static async exportOrders(orderIds, options = {}) {
          try {
            const exportModal = document.getElementById('exportProgress');
            const progressFill = document.getElementById('exportProgressFill');
            const statusText = document.getElementById('exportStatus');
            const detailsText = document.getElementById('exportDetails');

            // Show export modal
            exportModal.classList.add('show');
            statusText.textContent = 'Preparing export...';
            detailsText.textContent = `Exporting ${orderIds.length} orders`;
            progressFill.style.width = '10%';

            // Simulate progress steps
            await this.updateProgress(20, 'Gathering order data...', progressFill, statusText);
            await this.updateProgress(40, 'Processing order items...', progressFill, statusText);
            await this.updateProgress(60, 'Formatting Excel file...', progressFill, statusText);

            // Make API call
            const response = await fetch(`${API_BASE_URL}/orders/export`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                orderIds: orderIds,
                format: 'excel',
                includeItems: true,
                includeCustomer: true,
                includeAddress: true,
                ...options
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error?.message || 'Export failed');
            }

            await this.updateProgress(80, 'Finalizing export...', progressFill, statusText);
            await this.updateProgress(100, 'Download ready!', progressFill, statusText);

            // Hide modal
            setTimeout(() => {
              exportModal.classList.remove('show');
            }, 1000);

            // Trigger download
            if (data.data.downloadUrl) {
              const link = document.createElement('a');
              link.href = data.data.downloadUrl;
              link.download = data.data.fileName || 'orders-export.xlsx';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }

            ToastManager.show(`Successfully exported ${data.data.recordCount} orders`, 'success');

            return data;

          } catch (error) {
            console.error('Export Error:', error);
            document.getElementById('exportProgress').classList.remove('show');
            ToastManager.show('Failed to export orders: ' + error.message, 'error');
            throw error;
          }
        }

        static async updateProgress(percent, status, progressElement, statusElement) {
          return new Promise(resolve => {
            setTimeout(() => {
              progressElement.style.width = `${percent}%`;
              statusElement.textContent = status;
              resolve();
            }, 500);
          });
        }
      }

      // Bulk Operations Manager
      class BulkOperationsManager {
        static updateSelectedCount() {
          const count = selectedOrders.size;
          const bulkBar = document.getElementById('bulkActionsBar');
          const selectedCountText = document.getElementById('selectedCount');
          const bulkExportBtn = document.getElementById('bulkExportBtn');

          selectedCountText.textContent = `${count} order${count !== 1 ? 's' : ''} selected`;
          bulkExportBtn.disabled = count === 0;

          if (count > 0) {
            bulkBar.classList.add('show');
          } else {
            bulkBar.classList.remove('show');
          }
        }

        static toggleOrderSelection(orderId, checkbox) {
          if (checkbox.checked) {
            selectedOrders.add(orderId);
          } else {
            selectedOrders.delete(orderId);
          }

          // Update order row styling
          const orderRow = checkbox.closest('tr') || checkbox.closest('.order-card');
          if (orderRow) {
            orderRow.classList.toggle('selected', checkbox.checked);
          }

          this.updateSelectedCount();
          this.updateSelectAllState();
        }

        static selectAllOrders(selectAll = true) {
          const checkboxes = document.querySelectorAll('.order-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll;
            const orderId = checkbox.dataset.orderId;
            if (selectAll) {
              selectedOrders.add(orderId);
            } else {
              selectedOrders.delete(orderId);
            }

            // Update row styling
            const orderRow = checkbox.closest('tr') || checkbox.closest('.order-card');
            if (orderRow) {
              orderRow.classList.toggle('selected', selectAll);
            }
          });

          this.updateSelectedCount();
          this.updateSelectAllState();
        }

        static updateSelectAllState() {
          const selectAllCheckbox = document.getElementById('selectAllOrders');
          const checkboxes = document.querySelectorAll('.order-checkbox');
          const checkedCount = document.querySelectorAll('.order-checkbox:checked').length;

          if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          } else if (checkedCount === checkboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
          } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
          }
        }

        static async bulkUpdateStatus(status) {
          if (selectedOrders.size === 0) {
            ToastManager.show('Please select orders to update', 'warning');
            return;
          }

          try {
            const orderIds = Array.from(selectedOrders);

            const response = await fetch(`${API_BASE_URL}/orders/bulk-update`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                orderIds: orderIds,
                updates: {
                  status: status
                }
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error?.message || 'Bulk update failed');
            }

            ToastManager.show(`Updated ${data.data.updatedCount} orders to ${status}`, 'success');

            // Clear selection
            this.selectAllOrders(false);

            // Reload orders
            loadOrders();

          } catch (error) {
            console.error('Bulk Update Error:', error);
            ToastManager.show('Failed to update orders: ' + error.message, 'error');
          }
        }
      }

      // API Functions
      class OrdersAPI {
        static async fetchOrders(params = {}) {
          try {
            const queryParams = new URLSearchParams({
              page: params.page || currentPage,
              limit: params.limit || 10,
              search: params.search || currentSearch,
              status: currentFilters.status !== 'all' ? currentFilters.status : '',
              paymentStatus: currentFilters.paymentStatus || '',
              paymentMethod: currentFilters.paymentMethod || '',
              dateFrom: currentFilters.dateFrom || '',
              dateTo: currentFilters.dateTo || '',
              sortField: params.sortField || currentSort.field,
              sortDirection: params.sortDirection || currentSort.direction
            });

            // Remove empty parameters
            for (let [key, value] of queryParams.entries()) {
              if (!value || value === 'null') {
                queryParams.delete(key);
              }
            }

            const response = await fetch(`${API_BASE_URL}/orders?${queryParams}`);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.message || 'API returned unsuccessful response');
            }

            return data;
          } catch (error) {
            console.error('API Error:', error);
            throw error;
          }
        }

        static async getOrderDetails(orderId) {
          try {
            const response = await fetch(`${API_BASE_URL}/orders/${orderId}`);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return data;
          } catch (error) {
            console.error('Get Order Details Error:', error);
            throw error;
          }
        }
      }

      // UI State Management
      class UIManager {
        static showLoading() {
          document.getElementById('loadingState').classList.remove('hidden');
          document.getElementById('ordersContainer').classList.add('hidden');
          document.getElementById('errorState').classList.add('hidden');
          document.getElementById('emptyState').classList.add('hidden');
        }

        static showError(message = 'Something went wrong') {
          document.getElementById('errorMessage').textContent = message;
          document.getElementById('errorState').classList.remove('hidden');
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('ordersContainer').classList.add('hidden');
          document.getElementById('emptyState').classList.add('hidden');
        }

        static showEmpty() {
          document.getElementById('emptyState').classList.remove('hidden');
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('ordersContainer').classList.add('hidden');
          document.getElementById('errorState').classList.add('hidden');
        }

        static showOrders() {
          document.getElementById('ordersContainer').classList.remove('hidden');
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('errorState').classList.add('hidden');
          document.getElementById('emptyState').classList.add('hidden');
        }

        static updateFilterButtons(activeFilter, filterType) {
          document.querySelectorAll(`.filter-btn[data-type="${filterType}"]`).forEach(btn => {
            btn.classList.remove('filter-active');
            if (btn.dataset.filter === activeFilter) {
              btn.classList.add('filter-active');
            }
          });
        }
      }

      // Template Rendering
      class TemplateRenderer {
        static renderStatsCards(stats) {
          const statsContainer = document.getElementById('statsCards');
          statsContainer.innerHTML = `
          <div class="bg-white p-4 rounded-lg shadow-sm border fade-in">
            <div class="flex items-center">
              <div class="brand-teal text-white p-3 rounded-lg">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm text-gray-600">Total Orders</p>
                <p class="text-xl font-bold">${stats.totalOrders || 0}</p>
              </div>
            </div>
          </div>

          <div class="bg-white p-4 rounded-lg shadow-sm border fade-in">
            <div class="flex items-center">
              <div class="bg-purple-500 text-white p-3 rounded-lg">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm text-gray-600">Today's Orders</p>
                <p class="text-xl font-bold">${stats.todayOrders || 0}</p>
              </div>
            </div>
          </div>
          
          <div class="bg-white p-4 rounded-lg shadow-sm border fade-in">
            <div class="flex items-center">
              <div class="bg-blue-500 text-white p-3 rounded-lg">
                <i class="fas fa-clock"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm text-gray-600">Pending</p>
                <p class="text-xl font-bold">${stats.pendingOrders || 0}</p>
              </div>
            </div>
          </div>
          
          <div class="bg-white p-4 rounded-lg shadow-sm border fade-in">
            <div class="flex items-center">
              <div class="bg-green-500 text-white p-3 rounded-lg">
                <i class="fas fa-check-double"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm text-gray-600">Delivered</p>
                <p class="text-xl font-bold">${stats.deliveredOrders || 0}</p>
              </div>
            </div>
          </div>
          
          <div class="bg-white p-4 rounded-lg shadow-sm border fade-in">
            <div class="flex items-center">
              <div class="brand-orange text-white p-3 rounded-lg">
                <i class="fas fa-wallet"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm text-gray-600">Total Revenue</p>
                <p class="text-xl font-bold">AED ${(stats.totalRevenue || 0).toLocaleString()}</p>
              </div>
            </div>
          </div>
        `;
        }

        static renderDesktopTable(orders) {
          const tbody = document.getElementById('ordersTableBody');
          tbody.innerHTML = '';

          orders.forEach(order => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50 transition-colors fade-in';
            row.dataset.orderId = order._id;

            const orderItems = order.orderItems || [];
            const itemsPreview = orderItems.slice(0, 2).map(item => `${item.name} (${item.qty})`).join(', ');
            const remainingItems = orderItems.length > 2 ? ` +${orderItems.length - 2} more` : '';
            const isaDeliveryAssigned = order.deliveryExecutive && order.deliveryExecutive.assigned ? true : false;
            const deliveryBoyIdQuery = isaDeliveryAssigned ? `deliveryExecutive='${order.deliveryExecutive.id}'` : '';
            row.innerHTML = `
            <td class="p-4">
              <input type="checkbox" class="order-checkbox rounded border-gray-300 text-brand-teal focus:ring-brand-teal" 
                     data-order-id="${order._id}">
            </td>
            <td class="p-4">
              <div>
                <div class="font-semibold text-gray-900">${order.orderId}</div>
                <div class="text-sm text-gray-600">Store: ${order.storeId}</div>
              </div>
            </td>
            <td class="p-4">
              <div>
                <div class="font-medium text-gray-900">${order.address.fullName || 'N/A'}</div>
                <div class="text-sm text-gray-600">${order.address.phone || 'No phone'}</div>
                ${order.address ? `<div class="address-tooltip text-xs text-blue-600 cursor-help">
                  <i class="fas fa-map-marker-alt mr-1"></i>View Address
                  <div class="tooltip-content">
                    ${order.address.fullName || ''}<br>
                    ${order.address.building || ''}, ${order.address.flat || ''}<br>
                    ${order.address.street || ''}, ${order.address.area || ''}<br>
                    ${order.address.city || ''}
                  </div>
                </div>` : ''}
              </div>
            </td>
            <td class="p-4">
              <div class="order-items-preview">
                <div class="text-sm font-medium text-gray-900">${itemsPreview}${remainingItems}</div>
                <div class="text-xs text-gray-500">${orderItems.length} item${orderItems.length !== 1 ? 's' : ''}</div>
              </div>
            </td>
            <td class="p-4">
              <div class="font-semibold text-gray-900">AED ${order.totalAmount.toFixed(2)}</div>
              ${order.discount > 0 ? `<div class="text-xs text-green-600">-AED ${order.discount.toFixed(2)} discount</div>` : ''}
            </td>
            <td class="p-4">
              <div class="space-y-1">
                <span class="px-2 py-1 text-xs font-medium rounded-full payment-${order.paymentStatus.toLowerCase()}">
                  ${order.paymentStatus}
                </span>
                <div class="text-xs text-gray-600">${order.paymentMethod}</div>
              </div>
            </td>
            <td class="p-4">
              <select class="status-select status-${order.status.toLowerCase()}" data-order-id="${order._id}" data-original-value="${order.status}">
                <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                <option value="Placed" ${order.status === 'Placed' ? 'selected' : ''}>Placed</option>
                <option value="Confirmed" ${order.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
              </select>
            </td>
            <td class="p-4">
              <div class="text-sm text-gray-900">${new Date(order.orderDate).toLocaleDateString()}</div>
              <div class="text-xs text-gray-600">${new Date(order.orderDate).toLocaleTimeString()}</div>
            </td>

            <td class="p-4">
               <button ${deliveryBoyIdQuery} onclick="selectDeliveryExecutive('${order._id}')" style="cursor: pointer;">    
                 ${order.deliveryExecutive ? order.deliveryExecutive.name : 'N/A'}
                 <i  class="fas fa-chevron-down fa-sm"></i>  
               </button>
             </td>
            
          `;
            // <td class="p-4">
            //   <div class="flex space-x-2">
            //     <button class="text-blue-600 hover:text-blue-800 p-1" title="View Details" onclick="viewOrderDetails('${order._id}')">
            //       <i class="fas fa-eye"></i>
            //     </button>
            //     <button class="text-green-600 hover:text-green-800 p-1" title="Print Invoice" onclick="printInvoice('${order._id}')">
            //       <i class="fas fa-print"></i>
            //     </button>
            //   </div>
            // </td>
            tbody.appendChild(row);
          });

          // Setup order checkbox listeners
          document.querySelectorAll('.order-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
              BulkOperationsManager.toggleOrderSelection(e.target.dataset.orderId, e.target);
            });
          });

          // Setup status select listeners
          document.querySelectorAll('.status-select').forEach(select => {
            const orderId = select.dataset.orderId;
            OrderStatusManager.setupStatusSelect(select, orderId);
          });
        }

        static renderMobileCards(orders) {
          const container = document.getElementById('ordersMobileView');
          container.innerHTML = '';

          orders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'order-card p-4 border-b fade-in';
            card.dataset.orderId = order._id;

            const orderItems = order.orderItems || [];
            const itemsPreview = orderItems.slice(0, 3).map(item =>
              `<span class="order-item-badge">${item.name} (${item.qty})</span>`
            ).join('');
            const remainingItems = orderItems.length > 3 ? `<span class="order-item-badge">+${orderItems.length - 3} more</span>` : '';

            card.innerHTML = `
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center">
                <input type="checkbox" class="order-checkbox mr-3 rounded border-gray-300 text-brand-teal focus:ring-brand-teal" 
                       data-order-id="${order._id}">
                <div>
                  <h3 class="font-semibold text-gray-900">${order.orderId}</h3>
                  <p class="text-sm text-gray-500">${order.userId?.name || 'Unknown Customer'}</p>
                </div>
              </div>
              <div class="flex flex-col items-end space-y-1">
                <span class="status-badge px-2 py-1 text-xs font-medium rounded-full status-${order.status.toLowerCase()}">
                  ${order.status}
                </span>
                <span class="px-2 py-1 text-xs font-medium rounded-full payment-${order.paymentStatus.toLowerCase()}">
                  ${order.paymentStatus}
                </span>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-3">
              <div>
                <p class="text-xs text-gray-500 mb-1">Total Amount</p>
                <p class="font-semibold">AED ${order.totalAmount.toFixed(2)}</p>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Payment Method</p>
                <p class="text-sm">${order.paymentMethod}</p>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Order Date</p>
                <p class="text-sm">${new Date(order.orderDate).toLocaleDateString()}</p>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Items (${orderItems.length})</p>
                <div class="order-items-preview">
                  ${itemsPreview}${remainingItems}
                </div>
              </div>
            </div>

            <div class="mb-3">
              <p class="text-xs text-gray-500 mb-2">Update Status</p>
              <select class="status-select status-${order.status.toLowerCase()} w-full" data-order-id="${order._id}" data-original-value="${order.status}">
                <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                <option value="Placed" ${order.status === 'Placed' ? 'selected' : ''}>Placed</option>
                <option value="Confirmed" ${order.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
              </select>
            </div>
          `;

            container.appendChild(card);
          });

          // Setup mobile checkbox listeners
          document.querySelectorAll('.order-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
              BulkOperationsManager.toggleOrderSelection(e.target.dataset.orderId, e.target);
            });
          });

          // Setup mobile status select listeners
          document.querySelectorAll('.status-select').forEach(select => {
            const orderId = select.dataset.orderId;
            OrderStatusManager.setupStatusSelect(select, orderId);
          });
        }

        static renderPagination(pagination) {
          const infoContainer = document.getElementById('paginationInfo');
          const buttonsContainer = document.getElementById('paginationButtons');

          // Update pagination info
          const start = (pagination.currentPage - 1) * 10 + 1;
          const end = Math.min(pagination.currentPage * 10, pagination.totalOrders);
          infoContainer.innerHTML = `
          Showing <span class="font-medium">${start}</span> to <span class="font-medium">${end}</span> 
          of <span class="font-medium">${pagination.totalOrders}</span> orders
        `;

          // Update pagination buttons
          buttonsContainer.innerHTML = '';

          // Previous button
          const prevBtn = document.createElement('button');
          prevBtn.className = `px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors ${!pagination.hasPrev ? 'disabled:opacity-50 disabled:cursor-not-allowed' : ''}`;
          prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
          prevBtn.disabled = !pagination.hasPrev;
          prevBtn.onclick = () => pagination.hasPrev && changePage(pagination.currentPage - 1);
          buttonsContainer.appendChild(prevBtn);

          // Page numbers
          const startPage = Math.max(1, pagination.currentPage - 2);
          const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);

          for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `px-3 py-2 text-sm rounded-lg transition-colors ${i === pagination.currentPage ? 'bg-teal-600 text-white' : 'border border-gray-300 hover:bg-gray-50'}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => changePage(i);
            buttonsContainer.appendChild(pageBtn);
          }

          // Next button
          const nextBtn = document.createElement('button');
          nextBtn.className = `px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors ${!pagination.hasNext ? 'disabled:opacity-50 disabled:cursor-not-allowed' : ''}`;
          nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
          nextBtn.disabled = !pagination.hasNext;
          nextBtn.onclick = () => pagination.hasNext && changePage(pagination.currentPage + 1);
          buttonsContainer.appendChild(nextBtn);
        }

        static renderChart(chartData) {
          const ctx = document.getElementById('revenueChart').getContext('2d');

          new Chart(ctx, {
            type: 'line',
            data: {
              labels: chartData.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
              datasets: [{
                label: 'Orders',
                data: chartData.orders || [12, 19, 15, 25, 22, 30, 28],
                borderColor: '#1E7065',
                backgroundColor: 'rgba(30, 112, 101, 0.1)',
                yAxisID: 'y'
              }, {
                label: 'Revenue (AED)',
                data: chartData.revenue || [1200, 1900, 1500, 2500, 2200, 3000, 2800],
                borderColor: '#F59E0B',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                yAxisID: 'y1'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              scales: {
                x: {
                  display: true,
                  title: {
                    display: true,
                    text: 'Day'
                  }
                },
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: {
                    display: true,
                    text: 'Orders'
                  }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  title: {
                    display: true,
                    text: 'Revenue (AED)'
                  },
                  grid: {
                    drawOnChartArea: false,
                  },
                }
              },
              plugins: {
                legend: {
                  position: 'top',
                },
                title: {
                  display: false
                }
              }
            }
          });
        }
      }

      // Date Range Manager
      class DateRangeManager {
        static setupDateRangePicker() {
          const dateRangeBtn = document.getElementById('dateRangeBtn');
          const dateRangeDropdown = document.getElementById('dateRangeDropdown');
          const dateRangeText = document.getElementById('dateRangeText');

          // Toggle dropdown
          dateRangeBtn.addEventListener('click', () => {
            dateRangeDropdown.classList.toggle('show');
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!dateRangeBtn.contains(e.target) && !dateRangeDropdown.contains(e.target)) {
              dateRangeDropdown.classList.remove('show');
            }
          });

          // Preset buttons
          document.querySelectorAll('.date-preset').forEach(btn => {
            btn.addEventListener('click', () => {
              const preset = btn.dataset.preset;
              this.applyDatePreset(preset);
              dateRangeText.textContent = btn.textContent;
              dateRangeDropdown.classList.remove('show');
            });
          });

          // Apply custom date range
          document.getElementById('applyDateRange').addEventListener('click', () => {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if (dateFrom && dateTo) {
              currentFilters.dateFrom = dateFrom;
              currentFilters.dateTo = dateTo;
              dateRangeText.textContent = `${new Date(dateFrom).toLocaleDateString()} - ${new Date(dateTo).toLocaleDateString()}`;
              loadOrders();
            }

            dateRangeDropdown.classList.remove('show');
          });

          // Clear date range
          document.getElementById('clearDateRange').addEventListener('click', () => {
            currentFilters.dateFrom = '';
            currentFilters.dateTo = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            dateRangeText.textContent = 'All Time';
            dateRangeDropdown.classList.remove('show');
            loadOrders();
          });
        }

        static applyDatePreset(preset) {
          const today = new Date();
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);

          switch (preset) {
            case 'today':
              currentFilters.dateFrom = today.toISOString().split('T')[0];
              currentFilters.dateTo = today.toISOString().split('T')[0];
              break;
            case 'yesterday':
              currentFilters.dateFrom = yesterday.toISOString().split('T')[0];
              currentFilters.dateTo = yesterday.toISOString().split('T')[0];
              break;
            case 'last7days':
              const last7Days = new Date(today);
              last7Days.setDate(last7Days.getDate() - 7);
              currentFilters.dateFrom = last7Days.toISOString().split('T')[0];
              currentFilters.dateTo = today.toISOString().split('T')[0];
              break;
            case 'last30days':
              const last30Days = new Date(today);
              last30Days.setDate(last30Days.getDate() - 30);
              currentFilters.dateFrom = last30Days.toISOString().split('T')[0];
              currentFilters.dateTo = today.toISOString().split('T')[0];
              break;
            case 'thismonth':
              const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
              currentFilters.dateFrom = firstDay.toISOString().split('T')[0];
              currentFilters.dateTo = today.toISOString().split('T')[0];
              break;
          }

          loadOrders();
        }
      }

      // Main Functions
      async function loadOrders() {
        UIManager.showLoading();

        try {
          // Clear selections when loading new data
          selectedOrders.clear();
          BulkOperationsManager.updateSelectedCount();

          const response = await OrdersAPI.fetchOrders();
          // For demo purposes, you can also use: const response = await simulateAPICall();

          if (response.data.orders.length === 0) {
            UIManager.showEmpty();
            return;
          }

          allOrders = response.data.orders;

          UIManager.showOrders();
          TemplateRenderer.renderStatsCards(response.data.stats);
          TemplateRenderer.renderDesktopTable(response.data.orders);
          TemplateRenderer.renderMobileCards(response.data.orders);
          TemplateRenderer.renderPagination(response.data.pagination);

          // Render chart if data is available
          if (response.data.chartData) {
            TemplateRenderer.renderChart(response.data.chartData);
          }

        } catch (error) {
          console.error('Load Orders Error:', error);
          UIManager.showError(error.message || 'Failed to load orders');
        }
      }

      // Mock API simulation for demo (replace with actual API calls)
      async function simulateAPICall() {
        await new Promise(resolve => setTimeout(resolve, 1000));

        const mockOrders = generateMockOrders();
        const filteredOrders = filterMockOrders(mockOrders);

        return {
          success: true,
          data: {
            orders: filteredOrders.slice((currentPage - 1) * 10, currentPage * 10),
            pagination: {
              currentPage: currentPage,
              totalPages: Math.ceil(filteredOrders.length / 10),
              totalOrders: filteredOrders.length,
              limit: 10,
              hasNext: currentPage < Math.ceil(filteredOrders.length / 10),
              hasPrev: currentPage > 1
            },
            stats: {
              totalOrders: mockOrders.length,
              pendingOrders: mockOrders.filter(o => o.status === 'Pending').length,
              confirmedOrders: mockOrders.filter(o => o.status === 'Confirmed').length,
              processingOrders: mockOrders.filter(o => o.status === 'Processing').length,
              deliveredOrders: mockOrders.filter(o => o.status === 'Delivered').length,
              cancelledOrders: mockOrders.filter(o => o.status === 'Cancelled').length,
              totalRevenue: mockOrders.reduce((sum, order) => sum + order.totalAmount, 0),
              todayOrders: mockOrders.filter(o => {
                const today = new Date().toDateString();
                return new Date(o.orderDate).toDateString() === today;
              }).length,
              unpaidOrders: mockOrders.filter(o => o.paymentStatus === 'Unpaid').length
            },
            chartData: {
              labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
              orders: [12, 19, 15, 25, 22, 30, 28],
              revenue: [1200, 1900, 1500, 2500, 2200, 3000, 2800]
            }
          }
        };
      }

      function generateMockOrders() {
        const statuses = ['Pending', 'Placed', 'Confirmed', 'Processing', 'Delivered', 'Cancelled'];
        const paymentStatuses = ['Paid', 'Unpaid', 'Failed'];
        const paymentMethods = ['Cash', 'Online'];

        const orders = [];

        for (let i = 1; i <= 50; i++) {
          const orderDate = new Date();
          orderDate.setDate(orderDate.getDate() - Math.floor(Math.random() * 30));

          const order = {
            _id: `order_${i}`,
            orderId: `ORD-2023-${String(i).padStart(4, '0')}`,
            storeId: `STORE-${Math.floor(Math.random() * 3) + 1}`,
            userId: {
              _id: `user_${i}`,
              name: `Customer ${i}`,
              email: `customer${i}@example.com`,
              phone: `+971501234${String(i).padStart(3, '0')}`
            },
            orderDate: orderDate.toISOString(),
            status: statuses[Math.floor(Math.random() * statuses.length)],
            paymentStatus: paymentStatuses[Math.floor(Math.random() * paymentStatuses.length)],
            paymentMethod: paymentMethods[Math.floor(Math.random() * paymentMethods.length)],
            subTotal: 50 + Math.random() * 200,
            charges: [
              { name: 'Delivery Fee', amount: 10 },
              { name: 'Service Fee', amount: 5 }
            ],
            discount: Math.random() > 0.7 ? Math.random() * 20 : 0,
            totalAmount: 0, // Will be calculated
            couponCode: Math.random() > 0.8 ? 'SAVE10' : null,
            orderItems: [
              {
                productId: 'prod1',
                name: 'Classic Espresso',
                image: 'https://images.unsplash.com/photo-1510707577719-ae7c14805e3a?w=60',
                qty: Math.floor(Math.random() * 3) + 1,
                unitPrice: 18,
                total: 0
              },
              {
                productId: 'prod2',
                name: 'Chocolate Croissant',
                image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=60',
                qty: Math.floor(Math.random() * 2) + 1,
                unitPrice: 16.50,
                total: 0
              }
            ],
            address: {
              fullName: `Customer ${i}`,
              phone: `+971501234${String(i).padStart(3, '0')}`,
              building: `Building ${i}`,
              flat: `${Math.floor(Math.random() * 20) + 1}`,
              street: 'Sheikh Zayed Road',
              area: 'Downtown Dubai',
              city: 'Dubai',
              landmark: 'Near Dubai Mall',
              notes: 'Please call upon arrival'
            },
            assignedTo: Math.random() > 0.5 ? {
              _id: 'delivery1',
              name: 'Mohammed Ali',
              phone: '+971507654321'
            } : null,
            updatedAt: orderDate.toISOString()
          };

          // Calculate totals
          order.orderItems.forEach(item => {
            item.total = item.qty * item.unitPrice;
          });

          const itemsTotal = order.orderItems.reduce((sum, item) => sum + item.total, 0);
          const chargesTotal = order.charges.reduce((sum, charge) => sum + charge.amount, 0);
          order.subTotal = itemsTotal;
          order.totalAmount = itemsTotal + chargesTotal - order.discount;

          orders.push(order);
        }

        return orders;
      }

      function filterMockOrders(orders) {
        let filtered = [...orders];

        // Apply search filter
        if (currentSearch) {
          filtered = filtered.filter(order =>
            order.orderId.toLowerCase().includes(currentSearch.toLowerCase()) ||
            order.userId?.name.toLowerCase().includes(currentSearch.toLowerCase()) ||
            order.userId?.phone.includes(currentSearch)
          );
        }

        // Apply status filter
        if (currentFilters.status !== 'all') {
          filtered = filtered.filter(order => order.status === currentFilters.status);
        }

        // Apply payment status filter
        if (currentFilters.paymentStatus) {
          filtered = filtered.filter(order => order.paymentStatus === currentFilters.paymentStatus);
        }

        // Apply payment method filter
        if (currentFilters.paymentMethod) {
          filtered = filtered.filter(order => order.paymentMethod === currentFilters.paymentMethod);
        }

        // Apply date range filter
        if (currentFilters.dateFrom && currentFilters.dateTo) {
          const fromDate = new Date(currentFilters.dateFrom);
          const toDate = new Date(currentFilters.dateTo);
          toDate.setHours(23, 59, 59, 999); // Include the entire end date

          filtered = filtered.filter(order => {
            const orderDate = new Date(order.orderDate);
            return orderDate >= fromDate && orderDate <= toDate;
          });
        }

        // Apply sorting
        if (currentSort.field) {
          filtered.sort((a, b) => {
            let aVal, bVal;

            if (currentSort.field === 'orderDate') {
              aVal = new Date(a.orderDate);
              bVal = new Date(b.orderDate);
            } else if (currentSort.field === 'totalAmount') {
              aVal = a.totalAmount;
              bVal = b.totalAmount;
            } else {
              aVal = a[currentSort.field];
              bVal = b[currentSort.field];
            }

            const modifier = currentSort.direction === 'asc' ? 1 : -1;
            return aVal > bVal ? modifier : aVal < bVal ? -modifier : 0;
          });
        }

        return filtered;
      }

      // Event Handlers
      function handleSearch(value) {
        currentSearch = value;
        currentPage = 1;
        loadOrders();

        const clearBtn = document.getElementById('clearSearch');
        if (value) {
          clearBtn.classList.remove('hidden');
        } else {
          clearBtn.classList.add('hidden');
        }
      }

      function handleFilter(filter, filterType) {
        currentPage = 1;

        if (filterType === 'status') {
          currentFilters.status = filter;
          UIManager.updateFilterButtons(filter, 'status');
        } else if (filterType === 'payment') {
          currentFilters.paymentStatus = filter;
          UIManager.updateFilterButtons(filter, 'payment');
        } else if (filterType === 'method') {
          currentFilters.paymentMethod = filter;
          UIManager.updateFilterButtons(filter, 'method');
        }

        loadOrders();
      }

      function changePage(page) {
        currentPage = page;
        loadOrders();
      }

      function handleSort(field) {
        if (currentSort.field === field) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.field = field;
          currentSort.direction = 'asc';
        }
        loadOrders();
      }

      function viewOrderDetails(orderId) {
        // Navigate to order details page or open modal
        window.location.href = `/orders/view/${orderId}`;
      }

      function printInvoice(orderId) {
        // Open print dialog or generate PDF
        window.open(`/orders/${orderId}/invoice`, '_blank');
      }

      function clearFilters() {
        currentFilters = {
          status: 'all',
          paymentStatus: '',
          paymentMethod: '',
          dateFrom: '',
          dateTo: ''
        };
        currentSearch = '';
        currentPage = 1;

        document.getElementById('searchInput').value = '';
        document.getElementById('clearSearch').classList.add('hidden');
        document.getElementById('dateRangeText').textContent = 'All Time';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';

        // Reset filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('filter-active');
        });
        document.querySelector('.filter-btn[data-filter="all"]').classList.add('filter-active');

        loadOrders();
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', function () {
        // Load initial data
        loadOrders();

        // Setup date range picker
        DateRangeManager.setupDateRangePicker();

        // Setup event listeners
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function (e) {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => handleSearch(e.target.value), 300);
        });

        // Clear search button
        document.getElementById('clearSearch').addEventListener('click', function () {
          searchInput.value = '';
          handleSearch('');
        });

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', function () {
            const filter = this.dataset.filter;
            const filterType = this.dataset.type;

            // Don't apply filter if already active (except for status 'all')
            if (this.classList.contains('filter-active') && filter !== 'all') {
              // Deactivate filter
              this.classList.remove('filter-active');
              if (filterType === 'status') {
                currentFilters.status = 'all';
                document.querySelector('.filter-btn[data-filter="all"]').classList.add('filter-active');
              } else if (filterType === 'payment') {
                currentFilters.paymentStatus = '';
              } else if (filterType === 'method') {
                currentFilters.paymentMethod = '';
              }
            } else {
              handleFilter(filter, filterType);
            }
          });
        });

        // Sort buttons
        document.getElementById('sortByAmount').addEventListener('click', () => handleSort('totalAmount'));
        document.getElementById('sortByDate').addEventListener('click', () => handleSort('orderDate'));

        // Bulk operations
        document.getElementById('selectAllOrders').addEventListener('change', function () {
          BulkOperationsManager.selectAllOrders(this.checked);
        });

        document.getElementById('selectAllBtn').addEventListener('click', () => {
          BulkOperationsManager.selectAllOrders(true);
        });

        document.getElementById('clearSelectionBtn').addEventListener('click', () => {
          BulkOperationsManager.selectAllOrders(false);
        });

        document.getElementById('bulkUpdateBtn').addEventListener('click', () => {
          const status = document.getElementById('bulkStatusUpdate').value;
          if (status) {
            BulkOperationsManager.bulkUpdateStatus(status);
            document.getElementById('bulkStatusUpdate').value = '';
          }
        });

        // Export buttons
        document.getElementById('bulkExportBtn').addEventListener('click', () => {
          if (selectedOrders.size > 0) {
            ExportManager.exportOrders(Array.from(selectedOrders));
          }
        });

        document.getElementById('bulkExportSelectedBtn').addEventListener('click', () => {
          if (selectedOrders.size > 0) {
            ExportManager.exportOrders(Array.from(selectedOrders));
          }
        });

        // Other buttons
        document.getElementById('retryBtn').addEventListener('click', loadOrders);
        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
      });

      // Global functions
      window.viewOrderDetails = viewOrderDetails;
      window.printInvoice = printInvoice;
    </script>
    <%- include('./deliveryBoySelection') %>
      <%- include('../../partials/Footer') %>