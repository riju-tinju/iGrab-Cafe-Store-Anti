<style>
    /* Modal Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: flex-end;
        align-items: flex-end;
        z-index: 1000;
    }

    .modal-content {
        background-color: white;
        border-radius: 20px 20px 0 0;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 20px;
        animation: slideUp 0.3s ease;
    }

    /* Cart and Wishlist Styles */
    .cart-modal,
    .wishlist-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: flex-end;
        align-items: flex-end;
        z-index: 1000;
    }

    .cart-content,
    .wishlist-content {
        background-color: white;
        border-radius: 20px 20px 0 0;
        width: 100%;
        height: 80vh;
        padding: 20px;
        animation: slideUp 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .cart-header,
    .wishlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        margin-bottom: 15px;
        color: black;
    }

    .cart-items,
    .wishlist-items {
        flex-grow: 1;
        overflow-y: auto;
        scrollbar-width: thin;
        padding-right: 10px;
    }

    .cart-item,
    .wishlist-item {
        display: flex;
        padding: 10px 0;
        border-bottom: 1px solid #f5f5f5;
    }

    .item-image {
        width: 70px;
        height: 70px;
        border-radius: 8px;
        background-size: cover;
        background-position: center;
        margin-right: 15px;
    }

    .item-details {
        flex-grow: 1;
    }

    .item-quantity {
        display: flex;
        align-items: center;
        margin-top: 8px;
    }

    .qty-btn {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: #f5f5f5;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1rem;
        cursor: pointer;
    }

    .qty-input {
        width: 40px;
        text-align: center;
        border: none;
        font-weight: 600;
    }

    .cart-footer,
    .wishlist-footer {
        padding-top: 15px;
        border-top: 1px solid #eee;
        margin-top: 10px;
    }

    .cart-charges {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-weight: 500;
        font-size: 14px;
        color: #4C5357;
    }

    .cart-total {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-weight: 600;
        font-family: 'Chillax', sans-serif !important;
        font-weight: 700;
    }

    /* Skeleton Loading Styles */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
    }

    .skeleton-item {
        display: flex;
        padding: 10px 0;
        border-bottom: 1px solid #f5f5f5;
    }

    .skeleton-image {
        width: 70px;
        height: 70px;
        border-radius: 8px;
        margin-right: 15px;
    }

    .skeleton-text {
        height: 12px;
        margin-bottom: 8px;
        width: 80%;
    }

    .skeleton-text.short {
        width: 40%;
    }

    .error-message {
        color: #e53e3e;
        text-align: center;
        padding: 20px;
        background-color: #fff5f5;
        border-radius: 8px;
        margin: 20px 0;
    }

    /* Animations */
    @keyframes slideUp {
        from {
            transform: translateY(100%);
        }

        to {
            transform: translateY(0);
        }
    }

    @keyframes slideRight {
        from {
            transform: translateX(-100%);
        }

        to {
            transform: translateX(0);
        }
    }

    @keyframes loading {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    /* Desktop Styles */
    @media (min-width: 768px) {

        .modal-content,
        .cart-content,
        .wishlist-content {
            width: 450px;
            max-width: 90%;
            border-radius: 20px;
            margin: 40px;
            height: auto;
            max-height: 80vh;
        }
    }
</style>

<head>
    <!-- Material Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.9.96/css/materialdesignicons.min.css" rel="stylesheet" />
</head>
<!-- Cart Modal -->
<div class="cart-modal">
    <div class="cart-content">
        <div class="cart-header">
            <h2 class="text-xl font-bold">Your Cart</h2>
            <button id="close-cart" class="close-cart">
                <i class="mdi mdi-close text-xl"></i>
            </button>
        </div>

        <div id="cart-items-container" class="cart-items">
            <!-- Cart items will be loaded here -->
            <div class="text-center py-8">
                <i class="mdi mdi-cart-outline text-4xl text-gray-400"></i>
                <p class="mt-2 text-gray-500">Your cart is empty</p>
                <button class="secondary-btn mt-4">Shop Now</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Cart Modal Functionality
    const cartBtn = document.getElementById("cart-btn"); // Trigger button
    const desktopCartBtn = document.getElementById("desktop-cart-btn"); // Desktop trigger
    const cartItemsContainer = document.getElementById("cart-items-container");
    const cartModal = document.querySelector(".cart-modal");
    const closeCartBtn = document.querySelector(".close-cart");

    // Event Listeners
    cartBtn?.addEventListener("click", openCartModal);
    desktopCartBtn?.addEventListener("click", openCartModal);
    closeCartBtn.addEventListener("click", closeCartModal);

    function openCartModal() {
        cartModal.style.display = "flex";
        loadCartItems();
    }

    function closeCartModal() {
        cartModal.style.display = "none";
        document.getElementById("checkoutBtn")?.remove();
        document.querySelector(".cart-footer")?.remove();
    }

    function loadCartItems() {
        showCartSkeleton();

        fetchCartItems()
            .then((data) => {
                console.log("Cart items loaded:", data);
                renderCartItems(data[0]);
            })
            .catch((error) => {
                showCartError("Failed to load cart items. Please try again.");
                console.error("Cart fetch error:", error);
            });
    }

    function showCartSkeleton() {
        let skeletonHTML = "";
        for (let i = 0; i < 3; i++) {
            skeletonHTML += `
                <div class="skeleton-item">
                    <div class="skeleton skeleton-image"></div>
                    <div class="flex-1">
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text short"></div>
                        <div class="mt-2 skeleton w-16 h-6 rounded"></div>
                    </div>
                </div>`;
        }
        cartItemsContainer.innerHTML = skeletonHTML;
    }

    function showCartError(message) {
        cartItemsContainer.innerHTML = `
            <div class="error-message">
                <i class="mdi mdi-alert-circle text-2xl mb-2"></i>
                <p>${message}</p>
            </div>`;
    }

    function updateCart(action, itemId) {
        // alert(`Update cart: ${action} for item ${itemId}`);
        // Handle quantity update logic here
        console.log(`Update cart: ${action} for item ${itemId}`);
        // You can implement the logic to update the cart on the server
        if (action == 'PLUS') {
            AddOrMinusCartItemQty(action, itemId)
        }
        else if (action == 'MINUS') {
            AddOrMinusCartItemQty(action, itemId)
        }
        else if (action == 'REMOVE') {
            // Remove item from cart logic
            console.log(`Removing item ${itemId} from cart`);
            removeCartItem(itemId)
        }
        return true;
    }


    async function fetchCartItems() {
        try {
            const cartData = await Promise.all([
                fetch("/api/get-cart", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                }).then(res => {
                    if (!res.ok) throw new Error("Failed to fetch cart items");
                    return res.json();
                }),
                new Promise(resolve => setTimeout(resolve, 2000)),
            ]);
            return cartData;
        } catch (error) {
            await new Promise(resolve => setTimeout(resolve, 2000)); // Delay even on error
            throw error;
        }
    }


    function renderCartItems(cartObject) {
        const items = cartObject.items || [];
        if (items.length === 0) {
            cartItemsContainer.innerHTML = `
                <div class="text-center py-8">
                    <i class="mdi mdi-cart-outline text-4xl text-gray-400"></i>
                    <p class="mt-2 text-gray-500">Your cart is empty</p>
                    <button onclick="open_url('shop')" class="secondary-btn btn-secondary mt-4" style="background:#e6d4b8;color:black">Start Shopping</button>
                </div>`;
            return;
        }


        const sumOfcharges = cartObject.charges.reduce((accumulator, chargeObj) => {
            return accumulator + chargeObj.amount;
        }, 0)

        // Create footer with checkout button
        const footer = document.createElement("div");
        footer.classList.add("cart-footer");
        footer.innerHTML = `
                <div class="cart-charges">
                    <span>sub total</span>
                    <span id="sub-total">AED ${cartObject.subTotal || 'NA'}</span>
                </div>
                <div class="cart-charges">
                    <span>additional charges</span>
                    <span id='total-cart-charges'>AED ${sumOfcharges.toFixed(2) || 'NA'}</span>
                </div>
                <div class="cart-total">
                    <span>Total</span>
                    <span id="cart-total">AED ${cartObject.totalAmount || 0}</span>
                </div>
                
                <button onclick="open_url('checkout')" class="btn-primary w-full" id="checkoutBtn">Proceed to checkout</button>
            
            `;
        cartItemsContainer.parentNode.insertBefore(footer, cartItemsContainer.nextSibling);

        let cartHTML = "";

        items.forEach((item) => {

            const isOutOfStock = item.inStock === 0;
            const priceDisplay = isOutOfStock
                ? `<strike>AED ${item.price.toFixed(2)}</strike> <span class="text-red-500">Out of Stock</span>`
                : `AED ${item.price.toFixed(2)}`;

            cartHTML += `
                <div class="cart-item" data-id="${item.id}">
                    <div class="item-image" style="background-image: url('${item.image}')"></div>
                    <div class="item-details">
                        <div class="flex justify-between">
                            <h3 class="font-bold">${item.name}</h3>
                            <button class="remove-cart-item" onclick="updateCart('REMOVE', '${item.id}')" data-id="${item.id}">
                                <i class="mdi mdi-close text-gray-400"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500">${item.Category}</p>
                         
                        <div class="item-quantity mt-2">
                            <button onclick="updateCart('MINUS', '${item.id}')" class="qty-btn" ${isOutOfStock ? 'disabled' : ''}>-</button>
                            <input type="text" class="qty-input" data-id="${item.id}" value="${item.quantity}" readonly />
                            <button onclick="updateCart('PLUS','${item.id}')" class="qty-btn" ${isOutOfStock ? 'disabled' : ''} >+</button>
                        </div>
                        <div class="mt-2 font-bold">${priceDisplay}</div>
                    </div>
                </div>`;
        });

        cartItemsContainer.innerHTML = cartHTML;


    }

    async function removeCartItem(productId) {
        try {
            const response = await fetch("/api/remove-item-from-cart", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ productId })
            });

            if (!response.ok) {
                throw new Error("Failed to remove item from cart");
                return false;
            }

            const data = await response.json();
            if (data.cartCount === 0) {
                // If cart is empty, show empty cart message
                cartItemsContainer.innerHTML = `
                <div class="text-center py-8">
                    <i class="mdi mdi-cart-outline text-4xl text-gray-400"></i>
                    <p class="mt-2 text-gray-500">Your cart is empty</p>
                    <button onclick="open_url('shop')" class="secondary-btn btn-secondary mt-4" style="background:#e6d4b8;color:black">Start Shopping</button>
                </div>`;
                document.querySelector(".cart-footer")?.remove();
            }
            // Remove the DOM element with class 'cart-item' and matching data-id
            const cartItemElement = document.querySelector(`.cart-item[data-id='${productId}']`);
            if (cartItemElement) {
                cartItemElement.remove();
            }
            document.getElementById("sub-total").textContent = `AED ${data.subTotal || 'NA'}`;
            document.getElementById("total-cart-charges").textContent = `AED ${data.totalCharge || 'NA'}`;
            document.getElementById("cart-total").textContent = `AED ${data.totalAmount || 0}`;
            document.getElementById('cart-count').textContent = data.cartCount || 0;
            return true;
        } catch (error) {
            console.error("Error removing cart item:", error);
            showToast("Failed to remove the cart item");
            await new Promise(resolve => setTimeout(resolve, 2000)); // Optional delay for user experience
        }
    }

    async function AddOrMinusCartItemQty(action, productId) {
        try {
            const response = await fetch("/api/update-cartItem-qty", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ productId, action })
            });

            if (!response.ok) {
                throw new Error("Failed to update item from cart");
                return false;
            }

            const data = await response.json();

            if (data.isExitsTheItem == false && data.cartCount === 0) {
                // If cart is empty, show empty cart message
                cartItemsContainer.innerHTML = `
                <div class="text-center py-8">
                    <i class="mdi mdi-cart-outline text-4xl text-gray-400"></i>
                    <p class="mt-2 text-gray-500">Your cart is empty</p>
                    <button onclick="open_url('shop')" class="secondary-btn btn-secondary mt-4" style="background:#e6d4b8;color:black">Start Shopping</button>
                </div>`;
                document.querySelector(".cart-footer")?.remove();
                document.getElementById('cart-count').textContent = data.cartCount || 0;
            }

            if (data.isExitsTheItem == false) {
                // Remove the DOM element with class 'cart-item' and matching data-id
                const cartItemElement = document.querySelector(`.cart-item[data-id='${productId}']`);
                if (cartItemElement) {
                    cartItemElement.remove();
                }
            }
            document.querySelector(`.qty-input[data-id='${productId}']`).value = data.cartItemQty;
            document.getElementById("sub-total").textContent = `AED ${data.subTotal || 'NA'}`;
            document.getElementById("total-cart-charges").textContent = `AED ${data.totalCharge.toFixed(2) || 'NA'}`;
            document.getElementById("cart-total").textContent = `AED ${data.totalAmount || 0}`;
            document.getElementById('cart-count').textContent = data.cartCount || 0;
            return true;
        } catch (error) {
            console.error("Error removing cart item:", error);
            showToast("Failed to remove the cart item");
            await new Promise(resolve => setTimeout(resolve, 2000)); // Optional delay for user experience
        }
    }

</script>