<script>
  document.addEventListener('DOMContentLoaded', function() {
    const loadMoreBtn = document.getElementById('load_more_btn');
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', function() {
        optionSelections.page = optionSelections.page + 1
        loadMoreProducts(optionSelections);
      });
    }
  });

  function loadMoreProducts(filterObject) {
    const container = document.getElementById('product-skeleton-container');
    if (!container) {
      console.warn('Product container not found');
      return;
    }

    // Step 1: Get the last product card before loading
    const productCards = container.querySelectorAll('.product-card');
    const lastVisibleProduct = productCards[productCards.length - 1];

    // Step 2: Hide existing product cards (but keep them in DOM)
    productCards.forEach(card => card.classList.add('hide'));

    // Step 3: Show skeletons
    const skeletonHTML = generateSkeletons(6);
    container.insertAdjacentHTML('beforeend', skeletonHTML);

    const skeletonShownAt = Date.now();

    // Step 4: Fetch more products
    fetch('/get-products', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(filterObject)
      })
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        const elapsed = Date.now() - skeletonShownAt;
        const wait = elapsed < 1000 ? 1000 - elapsed : 0;

        setTimeout(() => {
          // Step 5: Remove skeletons
          const skeletons = container.querySelectorAll('.skeleton-card');
          skeletons.forEach(s => s.remove());

          // Step 6: Show previous products
          productCards.forEach(card => card.classList.remove('hide'));

          // Step 7: Render new products
          renderLoadProducts(data.filteredProducts,data.wishArray, {
            append: true
          }); // âœ… Assuming renderProducts supports append

          // Step 8: Smooth scroll to the last product that was visible
          if (lastVisibleProduct) {
            lastVisibleProduct.scrollIntoView({
              behavior: 'smooth',
              block: 'end'
            });
          }
        }, wait);
      })
      .catch(error => {
        console.error('Failed to load products:', error);
        const skeletons = container.querySelectorAll('.skeleton-card');
        showToast('An error occurred while loading products');
        setTimeout(() => {
          skeletons.forEach(s => s.remove());
          productCards.forEach(card => card.classList.remove('hide'));
        }, 3000);
      });
  }


function renderLoadProducts(products,wishArray, options = {}) {
  const container = document.getElementById('product-skeleton-container');
  if (!container) {
    console.warn('Product container not found');
    return;
  }

  // Step 1: If not appending, clear existing products
  if (!options.append) {
    container.innerHTML = '';
  }

  // Step 2: Create product HTML
  products.forEach(product => {

    // Liked heart icon
    const customer = <%- JSON.stringify(customer) %>
    customer.wishlist = wishArray
    let checkWish = customer.wishlist.some(item => item.toString() === product._id.toString());
    let heartOneclickFunctionHtml=`onclick="add_or_remove_product_to_wishlist('${product._id}',this)" btn-product-id="${product._id}"`
    const liked = checkWish ? 'fas fa-heart text-accent' : 'far fa-heart text-gray-600';


    const name = product.name?.en || 'Unnamed Product';
    const urlSlug = product.meta?.slug || '';
    const categoryName = product.category.name || '';
    const imageUrl = product.images?.[0] || 'https://via.placeholder.com/300x200';
    const price = product.pricing?.price?.toFixed(2) || '0.00';
    const currency = product.pricing?.currency || 'AED';
    const review = product.sales?.starRating || 0;
    const reviewCount = product.sales?.totalReviews || 0;
    // const liked = product.liked ? 'fas fa-heart text-red-500' : 'far fa-heart text-gray-600';

    const starsHTML = Array.from({ length: 5 }, (_, i) =>
      i < review
        ? '<i class="fas fa-star text-sm text-accent"></i>'
        : '<i class="far fa-star text-sm text-accent"></i>'
    ).join('');
    var productId = toString(product._id);
    const productHTML = `
      <div class="product-card">
        <div class="relative">
          <img src="${imageUrl}" alt="${name}" class="w-full h-48 object-cover">
          <button ${heartOneclickFunctionHtml} class="wishlist-btn absolute top-3 right-3 bg-white p-2 rounded-full shadow-md">
            <i class="${liked}"></i>
          </button>
        </div>
        <div class="p-4">
          <div class="text-sm text-gray-500 mb-1">${categoryName}</div>
          <a href="/product/${urlSlug}">
           <h3 class="font-bold mb-1">${name}</h3>
          </a>         
          <div class="flex items-center mb-3">
            <div class="flex text-accent">
              ${starsHTML}
            </div>
            <span class="text-sm text-gray-500 ml-1">(${reviewCount})</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="font-bold">${currency} ${price}</span>
            <button onclick="AddToCart('${product._id}')" id="addToCartButton" productId="${product._id}" class="add-to-cart bg-primary text-white p-2 rounded-full">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>
    `;

    container.insertAdjacentHTML('beforeend', productHTML);
  });
}



  function generateStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
      if (i <= rating) {
        stars += '<i class="fas fa-star text-sm"></i>';
      } else if (i - 0.5 <= rating) {
        stars += '<i class="fas fa-star-half-alt text-sm"></i>';
      } else {
        stars += '<i class="far fa-star text-sm"></i>';
      }
    }
    return stars;
  }
</script>