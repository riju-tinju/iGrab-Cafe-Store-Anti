<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGrab CafÃ© - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
    <style>
        :root {
            --primary-green: #003F2E;
            --accent-gold: #D69C4E;
            --bg-cream: #F9F9F9;
            --text-dark: #212121;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-cream);
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .input-field {
            width: 100%;
            padding: 16px;
            border: 2px solid #E5E7EB;
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            color: #333333;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-green);
            background: white;
        }

        .btn-primary {
            background: var(--primary-green);
            color: white;
            border-radius: 16px;
            padding: 16px;
            font-weight: 700;
            width: 100%;
            transition: transform 0.1s;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .otp-input {
            width: 50px;
            height: 60px;
            border-radius: 12px;
            border: 2px solid #E5E7EB;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            background: #F9FAFB;
            direction: ltr;
        }

        .otp-input:focus {
            border-color: var(--primary-green);
            background: white;
            outline: none;
        }

        /* Flip Animation */
        .card-flip {
            perspective: 1000px;
            position: relative;
            min-height: 100vh;
        }

        .card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        .flip-active .card-inner {
            transform: rotateY(180deg);
        }

        .card-face,
        .card-back {
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            padding: 32px 24px;
            -webkit-backface-visibility: hidden;
        }

        .card-back {
            transform: rotateY(180deg);
            z-index: 2;
        }

        .card-flip:not(.flip-active) .card-back {
            visibility: hidden;
        }

        .flip-active .card-face:first-child {
            visibility: hidden;
        }
    </style>
</head>

<body>
    <div class="mobile-container" x-data="authApp()">
        <div class="card-flip" :class="{'flip-active': step === 'otp'}">
            <div class="card-inner">

                <!-- LOGIN / SIGNUP SCREEN -->
                <div class="card-face flex flex-col justify-center">
                    <div class="mb-8 text-center">
                        <div
                            class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-primary-green">
                            <i class="fas fa-coffee"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2"
                            x-text="authMode === 'login' ? 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ù† Ø¬Ø¯ÙŠØ¯!' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯'">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!</h1>
                        <p class="text-gray-500"
                            x-text="authMode === 'login' ? 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©' : 'Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„ØªØ³Ø¬ÙŠÙ„'">Ø£Ø¯Ø®Ù„
                            Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                    </div>

                    <div x-show="error" x-transition
                        class="mb-4 p-4 bg-red-50 text-red-600 rounded-xl text-sm flex items-center">
                        <i class="fas fa-exclamation-circle ml-2"></i>
                        <span x-text="error"></span>
                    </div>

                    <form @submit.prevent="submitPhone">
                        <!-- Name Input (Signup only) -->
                        <div class="mb-4" x-show="authMode === 'signup'" x-transition>
                            <label class="block text-sm font-bold text-gray-700 mb-2 mr-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                            <input type="text" x-model="form.name" class="input-field" placeholder="Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§">
                        </div>

                        <!-- Phone Input -->
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-700 mb-2 mr-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…ØªØ­Ø±Ùƒ</label>
                            <div class="flex flex-row-reverse space-x-3 space-x-reverse">
                                <select x-model="form.countryCode" class="input-field bg-white flex-none"
                                    style="width: 110px; padding: 16px 8px;">
                                    <option value="+971">ğŸ‡¦ğŸ‡ª +971</option>
                                    <option value="+91">ğŸ‡®ğŸ‡³ +91</option>
                                    <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                                    <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
                                    <option value="+966">ğŸ‡¸ğŸ‡¦ +966</option>
                                </select>
                                <input type="tel" x-model="form.phone" class="input-field flex-1"
                                    style="min-width: 0; direction: ltr;" placeholder="50 123 4567" inputmode="numeric">
                            </div>
                        </div>

                        <button type="submit" class="btn-primary flex items-center justify-center" :disabled="loading">
                            <span x-show="!loading">
                                <span x-text="authMode === 'login' ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'"></span>
                                <i class="fas fa-arrow-left mr-2"></i>
                            </span>
                            <span x-show="loading"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </form>

                    <!-- Toggle Link -->
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            <span x-text="authMode === 'login' ? 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ' : 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ'"></span>
                            <button @click="authMode = (authMode === 'login' ? 'signup' : 'login'); error = ''"
                                class="text-primary-green font-bold hover:underline mr-1"
                                x-text="authMode === 'login' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'">
                            </button>
                        </p>
                    </div>

                    <p class="mt-8 text-center text-xs text-gray-400">
                        Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§.
                    </p>
                </div>

                <!-- OTP VERIFICATION SCREEN -->
                <div class="card-back flex flex-col justify-center">
                    <div class="absolute top-8 right-6">
                        <button @click="backToLogin"
                            class="text-gray-400 hover:text-gray-900 flex items-center transition-colors">
                            <i class="fas fa-arrow-right text-xl ml-2"></i>
                            <span class="text-sm font-medium">Ø±Ø¬ÙˆØ¹</span>
                        </button>
                    </div>

                    <div class="text-center mb-8">
                        <div
                            class="w-16 h-16 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-yellow-600">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-2">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ</h2>
                        <p class="text-gray-500 text-sm">
                            ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ <span class="font-bold text-gray-900"
                                style="direction: ltr; display: inline-block;"
                                x-text="`${form.countryCode} ${form.phone}`"></span>
                        </p>
                    </div>

                    <div x-show="otpError" x-transition
                        class="mb-6 p-3 bg-red-50 text-red-600 rounded-xl text-sm flex items-center justify-center">
                        <i class="fas fa-exclamation-circle ml-2"></i>
                        <span x-text="otpErrorMessage"></span>
                    </div>

                    <div class="flex justify-center space-x-2 mb-8" style="direction: ltr;">
                        <template x-for="(digit, index) in 6" :key="index">
                            <input type="text" maxlength="1" class="otp-input" :id="'otp-'+index" x-model="otp[index]"
                                @input="handleOtpInput($event, index)"
                                @keydown.backspace="handleBackspace($event, index)" inputmode="numeric">
                        </template>
                    </div>

                    <button @click="verifyOtp" class="btn-primary mb-6 flex items-center justify-center"
                        :disabled="loading">
                        <span x-show="!loading">ØªØ­Ù‚Ù‚ ÙˆØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                        <span x-show="loading"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>

                    <div class="text-center">
                        <p class="text-sm text-gray-500 mb-2">Ù„Ù… ÙŠØµÙ„Ùƒ Ø§Ù„Ø±Ù…Ø²ØŸ</p>
                        <button @click="resendOtp" class="text-primary-green font-bold text-sm hover:underline"
                            :disabled="timer > 0">
                            <span x-show="timer > 0">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø®Ù„Ø§Ù„ <span x-text="timer"></span> Ø«Ø§Ù†ÙŠØ©</span>
                            <span x-show="timer === 0">Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        function authApp() {
            return {
                authMode: 'login', // login | signup
                step: 'login', // login | otp
                loading: false,
                error: '',
                otpError: false,
                otpErrorMessage: '',
                timer: 60,
                interval: null,

                form: {
                    name: '',
                    countryCode: '+971',
                    phone: ''
                },
                otp: ['', '', '', '', '', ''],

                async submitPhone() {
                    if (this.authMode === 'signup' && !this.form.name) return this.error = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„";
                    if (!this.form.phone) return this.error = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ø§Ù„Ù…ØªØ­Ø±Ùƒ";

                    const phoneClean = this.form.phone.replace(/\s+/g, '');
                    if (!/^\d+$/.test(phoneClean)) {
                        return this.error = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)";
                    }
                    if (phoneClean.length < 7 || phoneClean.length > 15) {
                        return this.error = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ (7-15 Ø±Ù‚Ù…Ø§Ù‹)";
                    }

                    this.loading = true;
                    this.error = '';

                    try {
                        const res = await fetch('/api/auth/signup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...this.form,
                                authMode: this.authMode
                            })
                        });
                        const data = await res.json();

                        if (res.ok) {
                            this.step = 'otp';
                            this.startTimer();
                            setTimeout(() => document.getElementById('otp-0').focus(), 500);
                        } else {
                            if (data.code === 'USER_NOT_FOUND' && this.authMode === 'login') {
                                this.error = "Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' Ø£Ø¯Ù†Ø§Ù‡.";
                            } else if (data.code === 'USER_ALREADY_EXISTS') {
                                this.error = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
                            } else if (res.status === 429) {
                                this.error = "Ø¹Ø¯Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø©.";
                            } else {
                                this.error = data.error || data.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§";
                            }
                        }
                    } catch (e) {
                        this.error = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©";
                    } finally {
                        this.loading = false;
                    }
                },

                async verifyOtp() {
                    const code = this.otp.join('');
                    if (code.length < 6) return;

                    this.loading = true;
                    this.otpError = false;

                    try {
                        const res = await fetch('/api/auth/verify-otp', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                countryCode: this.form.countryCode,
                                phone: this.form.phone,
                                otp: code
                            })
                        });
                        const data = await res.json();

                        if (res.ok) {
                            window.location.href = '/';
                        } else {
                            this.otpError = true;
                            if (res.status === 429) {
                                this.otpErrorMessage = "Ø¹Ø¯Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø©.";
                            } else {
                                this.otpErrorMessage = data.error || "Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­";
                            }
                            this.otp = ['', '', '', '', '', ''];
                            document.getElementById('otp-0').focus();
                        }
                    } catch (e) {
                        this.otpError = true;
                        this.otpErrorMessage = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©";
                    } finally {
                        this.loading = false;
                    }
                },

                handleOtpInput(e, index) {
                    const val = e.target.value;
                    if (!/^\d*$/.test(val)) {
                        this.otp[index] = '';
                        return;
                    }
                    if (val && index < 5) {
                        document.getElementById('otp-' + (index + 1)).focus();
                    }
                },

                handleBackspace(e, index) {
                    if (!this.otp[index] && index > 0) {
                        document.getElementById('otp-' + (index - 1)).focus();
                    }
                },

                backToLogin() {
                    this.step = 'login';
                    this.otp = ['', '', '', '', '', ''];
                    this.error = '';
                    if (this.interval) clearInterval(this.interval);
                },

                startTimer() {
                    this.timer = 60;
                    if (this.interval) clearInterval(this.interval);
                    this.interval = setInterval(() => {
                        if (this.timer > 0) this.timer--;
                        else clearInterval(this.interval);
                    }, 1000);
                },

                async resendOtp() {
                    if (this.timer > 0) return;
                    this.startTimer();
                    try {
                        await fetch('/api/auth/signup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.form)
                        });
                    } catch (e) { }
                }
            }
        }
    </script>
</body>

</html>